<aside class="sidebar__right">
<nav class="toc">
    <header><h4 class="nav__title"><i class="fa fa-file-text"></i> On This Page</h4></header>
<ul class="toc__menu" id="markdown-toc">
  <li><a href="#what-is-the-service-layer-api-" id="markdown-toc-what-is-the-service-layer-api-">What is the Service-Layer API ?</a></li>
  <li><a href="#client-code-install-grpc-and-regenerate-bindings" id="markdown-toc-client-code-install-grpc-and-regenerate-bindings">Client Code: Install gRPC and regenerate bindings</a>    <ul>
      <li><a href="#connect-to-the-devbox" id="markdown-toc-connect-to-the-devbox">Connect to the Devbox</a></li>
      <li><a href="#clone-the-service-layer-object-model-repository" id="markdown-toc-clone-the-service-layer-object-model-repository">Clone the Service-Layer Object Model Repository</a></li>
      <li><a href="#install-the-protobuf-compiler" id="markdown-toc-install-the-protobuf-compiler">Install the Protobuf compiler</a></li>
      <li><a href="#install-grpc-tools" id="markdown-toc-install-grpc-tools">Install grpc tools</a></li>
      <li><a href="#view-proto-files-models" id="markdown-toc-view-proto-files-models">View .proto files (models)</a></li>
      <li><a href="#generate-python-bindings" id="markdown-toc-generate-python-bindings">Generate Python bindings</a></li>
    </ul>
  </li>
  <li><a href="#client-code-running-existing-tutorials" id="markdown-toc-client-code-running-existing-tutorials">Client Code: Running existing tutorials</a>    <ul>
      <li><a href="#install-grpcio-and-ipaddress-packages" id="markdown-toc-install-grpcio-and-ipaddress-packages">Install grpcio and ipaddress packages</a>        <ul>
          <li><a href="#for-python2" id="markdown-toc-for-python2">For python2</a></li>
          <li><a href="#for-python3" id="markdown-toc-for-python3">For Python3</a></li>
        </ul>
      </li>
      <li><a href="#running-pre-packaged-tutorials" id="markdown-toc-running-pre-packaged-tutorials">Running pre-packaged tutorials</a>        <ul>
          <li><a href="#list-the-existing-tutorials" id="markdown-toc-list-the-existing-tutorials">List the existing tutorials</a></li>
          <li><a href="#basic-client-initialization-client_initpy" id="markdown-toc-basic-client-initialization-client_initpy">Basic Client Initialization: client_init.py</a></li>
          <li><a href="#registerunregister-against-the-route-vertical-vrfpy" id="markdown-toc-registerunregister-against-the-route-vertical-vrfpy">Register/Unregister against the Route Vertical: vrf.py</a></li>
          <li><a href="#add-routes-to-ios-xr-rib-quickstartpy" id="markdown-toc-add-routes-to-ios-xr-rib-quickstartpy">Add Routes to IOS-XR RIB: quickstart.py</a></li>
          <li><a href="#add-routes-to-ios-xr-rib-routepy" id="markdown-toc-add-routes-to-ios-xr-rib-routepy">Add Routes to IOS-XR RIB: route.py</a></li>
          <li><a href="#register-and-listen-for-interface-state-events-interfacepy" id="markdown-toc-register-and-listen-for-interface-state-events-interfacepy">Register and Listen for interface state events: interface.py</a></li>
          <li><a href="#allocate-local-labels-and-create-ilm-entries-mpls_ilmpy" id="markdown-toc-allocate-local-labels-and-create-ilm-entries-mpls_ilmpy">Allocate Local labels and Create ILM entries: mpls_ilm.py</a></li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

  </nav>
</aside>

<blockquote>
  <p>Have a look at the set of Service-Layer learning labs on DevNet for more details on the Service-Layer 
API, associated configuration, details on writing your own gRPC clients in pythonm, c++ and more.
<a href="https://learninglabs.cisco.com/modules/iosxr-service-layer">https://learninglabs.cisco.com/modules/iosxr-service-layer</a></p>
</blockquote>

<h2 id="what-is-the-service-layer-api-">What is the Service-Layer API ?</h2>

<p>Let’s focus on the Service Adaptation layer from the earlier breakdown of the stack:</p>

<p><a href="/images/api_layers_service-layer.png"><img src="/images/api_layers_service-layer.png" alt="service-adaptation-layer" width="1000px" style="margin-left: auto !important; margin-right: auto !important;" /></a></p>

<p> <br />
   </p>

<p>The API offered to the end-user by the Service Adaptation layer is called the Service-Layer API. This API is quite distinct from the Management/Manageability layer APIs (CLI, Yang Models, Telemetry) in the sense that these APIs are not tied to the IOS-XR internal database called SYSDB.
This is shown in the figure below. The Manageability Layer derives its capabilities from SYSDB - The CLI and the YANG models are essentially interaction points for SYSDB data models representing the configuration and operational state of IOS-XR features and capabilities.</p>

<p> <br />
 </p>

<p style="text-align: center;">
<a href="/images/service-layer-sysdb-relation.png"><img src="/images/service-layer-sysdb-relation.png" alt="service-adaptation-layer" width="600px" style="margin-left: auto !important; margin-right: auto !important;" /></a>
</p>

<p> <br />
 </p>

<p>The Service-Layer API, however, is distinct. It gives the end-user access directly to the Network Infrastructure Layer (Service-Adaptation Layer), completely bypassing SYSDB.</p>

<p>This leads to some inherent characteristics of the Service Layer API:</p>

<ol>
  <li>
    <p>By not being tied to SYSDB, the Service-Layer APIs expose just the right amount of capabilities without being tied to the “feature knobs” supported by SYSDB. You get to control the state machine within the controller/agent/app that acts as a client to the Service-Layer API.</p>
  </li>
  <li>
    <p>By providing an API directly into the Network Infrastructure layer, when a client interacts with the API the number of layers that the request and subsequent calls have to traverse is lower compared to Manageability Layer APIs. As a result, Service Layer APIs are able to afford a very level of performance. We will showcase this when we utilize the API to program routes into IOS-XR RIB.</p>
  </li>
</ol>

<p>So, why do we need another API? A couple of customer(unnamed) quotes for your consumption:</p>

<blockquote>
  <p>“The multiple layers in the stack get in the way – We need better performance!”</p>
</blockquote>

<blockquote>
  <p>“I have my own controller/protocol, just give me complete access to the infrastructure underneath”</p>
</blockquote>

<blockquote class="notice--info">
  <p>Connect to your Pod first! Make sure your Anyconnect VPN connection to the Pod assigned to you is active.</p>

  <p>If you haven’t connected yet, check out the instructions to do so here:
<a href="https://sevt-sp.github.io/xr-programmability-lab/connect-to-pods/">https://sevt-sp.github.io/xr-programmability-lab/connect-to-pods/</a></p>

  <p>Once you’re connected, use the following instructions to connect to the individual nodes.
The instructions in the workshop will simply refer to the Name of the box to connect without
repeating the connection details and credentials. So refer back to this list when you need it.</p>

  <p>The 3 nodes in the topology are:</p>

  <p style="font-size: 16px;"><b>Development Linux System (DevBox)</b></p>
  <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> IP Address: 10.10.20.170
 Username/Password: [admin/admin]
 SSH Port: 2211
</code></pre></div>  </div>

  <p style="font-size: 16px;"><b>IOS-XRv9000 R1: (Router r1)</b></p>

  <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>IP Address: 10.10.20.170  
Username/Password: [admin/admin]   
Management IP: 10.10.20.170  
XR SSH Port: 2221    
NETCONF Port: 8321   
gRPC Port: 57021  
XR-Bash SSH Port: 2222    
</code></pre></div>  </div>

  <p style="font-size: 16px;"><b>IOS-XRv9000 R2:  (Router r2)</b></p>

  <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>IP Address: 10.10.20.170   
Username/Password: [admin/admin]   
Management IP: 10.10.20.170   
XR SSH Port: 2231    
NETCONF Port: 8331   
gRPC Port: 57031    
XR-Bash SSH Port: 2232
</code></pre></div>  </div>
</blockquote>

<p>The Topology in use is shown below:
<img src="/images/topology_devnet.png" alt="topology_devnet.png" /></p>

<h2 id="client-code-install-grpc-and-regenerate-bindings">Client Code: Install gRPC and regenerate bindings</h2>

<p>We will develop and run the service-layer python clients on the <code class="highlighter-rouge">devbox</code>. The sl-api client will connect to the router over gRPC. So, the steps we intend to perform as part of this section are:</p>

<ul>
  <li>
    <p><strong>Install the protoc compiler</strong> <code class="highlighter-rouge">python-pip</code> provides protoc using a <code class="highlighter-rouge">grpc-tools</code> package that we intend to use. Alternatively <code class="highlighter-rouge">protoc</code> can be built using protobuf:3.5.0 package from github.</p>
  </li>
  <li>
    <p>Provide the model (.proto) files to the compiler and <strong>generate bindings</strong> (i.e. actual code in the form of .py files from the .proto files). This generated code is then used as a set of libraries to create our own client code.</p>
  </li>
</ul>

<p>The process is depicted below:</p>

<p><img src="/images/protoc_compilation.png" alt="" />![protoc_compilation.png]</p>

<h3 id="connect-to-the-devbox">Connect to the Devbox</h3>

<p>Our next set of tasks will be performed on the devbox. Connection details are explained in the beginning of this lab. SSH into devbox:</p>

<p style="margin: 2em 0!important;padding: 0.85em;font-family: CiscoSans,Arial,Helvetica,sans-serif;font-size: 0.85em !important;text-indent: initial;background-color: #e6f2f7;border-radius: 5px;box-shadow: 0 1px 1px rgba(0,127,171,0.25);"><b>Username</b>: admin<br /><b>Password</b>: admin<br /><b>SSH port</b>: 2211
</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Laptop-Terminal:$ ssh -p 2211 admin@10.10.20.170
admin@10.10.20.170's password:
Last login: Sun Aug 26 19:18:39 2018 from 192.168.122.1
admin@devbox:~$
admin@devbox:~$

</code></pre></div></div>

<h3 id="clone-the-service-layer-object-model-repository">Clone the Service-Layer Object Model Repository</h3>

<p>As described in the 1st lab of this module, titled: <code class="highlighter-rouge">Service-Layer APIs: Bring your own Protocol/Controller</code>, the Service-Layer API is model-driven and uses protobuf IDLs to represent the models. These proto definitions can be found here:</p>

<blockquote>
  <p><a href="https://github.com/Cisco-Service-Layer/service-layer-objmodel/tree/master/grpc/protos">https://github.com/Cisco-Service-Layer/service-layer-objmodel/tree/master/grpc/protos</a></p>
</blockquote>

<p>Clone this git repository onto the devbox. We will clone the release <code class="highlighter-rouge">v0.0.1</code>.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>admin@devbox:~$ git clone https://github.com/Cisco-Service-Layer/service-layer-objmodel.git -b v0.0.1
Cloning into 'service-layer-objmodel'...
remote: Counting objects: 402, done.
remote: Compressing objects: 100% (45/45), done.
remote: Total 402 (delta 42), reused 44 (delta 25), pack-reused 332
Receiving objects: 100% (402/402), 7.60 MiB | 3.01 MiB/s, done.
Resolving deltas: 100% (214/214), done.
Checking connectivity... done.
admin@devbox:~$
</code></pre></div></div>

<h3 id="install-the-protobuf-compiler">Install the Protobuf compiler</h3>

<p>For <code class="highlighter-rouge">python</code>, the protobuf compiler (protoc) utility is packaged into the following pip-installable tool: <code class="highlighter-rouge">grpcio-tools</code>. We also need to install the tool <code class="highlighter-rouge">googleapis-common-protos</code> which contains python classes generated from protos in the <a href="https://github.com/googleapis/googleapis">googleapis</a> repository.</p>

<p>These tools are identified in the instructions laid out on <a href="https://grpc.io">https://grpc.io</a> for python client/server code generation:</p>

<blockquote>
  <p><a href="https://grpc.io/docs/tutorials/basic/python.html#generating-client-and-server-code">https://grpc.io/docs/tutorials/basic/python.html#generating-client-and-server-code</a></p>
</blockquote>

<p style="margin: 2em 0!important;padding: 0.85em;font-family: CiscoSans,Arial,Helvetica,sans-serif;font-size: 0.85em !important;text-indent: initial;background-color: #e6f2f7;border-radius: 5px;box-shadow: 0 1px 1px rgba(0,127,171,0.25);">The gRPC version that must be used for the client code is closely tied to the gRPC version used by the server code present in a given IOS-XR release.  

**In the IOS-XR Progammability sandbox, the routers are running IOS-XR release 6.4.1 which utilizes the gRPC version=`1.7.0`.  
Hence `grpcio` and the `grpcio-tools` package selected for this lab will have version=`1.7.0`**
</p>

<h3 id="install-grpc-tools">Install grpc tools</h3>

<p>The goal is to create bindings that are compatible for both python2 and python3 environments.</p>

<p>Owing to this issue:</p>
<blockquote>
  <p><a href="https://github.com/protocolbuffers/protobuf/issues/1491">https://github.com/protocolbuffers/protobuf/issues/1491</a></p>
</blockquote>

<p>it makes sense to generate bindings using python2 and transform them to a compatible state for python3 using the tool: <code class="highlighter-rouge">2to3</code>.</p>

<p>Therefore, installing <code class="highlighter-rouge">grpcio-tools</code> and <code class="highlighter-rouge">googleapis-common-protos</code> first for python2 (use <code class="highlighter-rouge">pip2</code> to install packages for python2):</p>

<p style="margin: 2em 0!important;padding: 0.85em;font-family: CiscoSans,Arial,Helvetica,sans-serif;font-size: 0.85em !important;text-indent: initial;background-color: #e6f2f7;border-radius: 5px;box-shadow: 0 1px 1px rgba(0,127,171,0.25);">Ignore the warnings related to pip permissions and version. They are harmless.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>admin@devbox:~<span class="nv">$ </span><span class="nb">sudo </span>pip2 install grpcio-tools<span class="o">==</span>1.7.0 googleapis-common-protos
The directory <span class="s1">'/home/admin/.cache/pip/http'</span> or its parent directory is not owned by the current user and the cache has been disabled. Please check the permissions and owner of that directory. If executing pip with <span class="nb">sudo</span>, you may want <span class="nb">sudo</span><span class="s1">'s -H flag.
The directory '</span>/home/admin/.cache/pip<span class="s1">' or its parent directory is not owned by the current user and caching wheels has been disabled. check the permissions and owner of that directory. If executing pip with sudo, you may want sudo'</span>s <span class="nt">-H</span> flag.
Collecting grpcio-tools<span class="o">==</span>1.7.0
  Downloading https://files.pythonhosted.org/packages/0e/c3/d9a9960f12e0bab789da875b1c9a3eb348b51fa3af9544c1edd1f7ef6000/grpcio_tools-1.7.0-cp27-cp27mu-manylinux1_x86_64.whl <span class="o">(</span>21.3MB<span class="o">)</span>
    100% |████████████████████████████████| 21.3MB 47kB/s
Collecting googleapis-common-protos
  Downloading https://files.pythonhosted.org/packages/00/03/d25bed04ec8d930bcfa488ba81a2ecbf7eb36ae3ffd7e8f5be0d036a89c9/googleapis-common-protos-1.5.3.tar.gz
Requirement already satisfied <span class="o">(</span>use <span class="nt">--upgrade</span> to upgrade<span class="o">)</span>: protobuf&gt;<span class="o">=</span>3.3.0 <span class="k">in</span> /usr/local/lib/python2.7/dist-packages <span class="o">(</span>from grpcio-tools<span class="o">==</span>1.7.0<span class="o">)</span>
Collecting grpcio&gt;<span class="o">=</span>1.7.0 <span class="o">(</span>from grpcio-tools<span class="o">==</span>1.7.0<span class="o">)</span>
  Downloading https://files.pythonhosted.org/packages/b5/84/c0d0a0355f2e3ea1e49fd81aa123e0bf42bfaa58be56583cc3b9baaf2837/grpcio-1.14.1-cp27-cp27mu-manylinux1_x86_64.whl <span class="o">(</span>9.2MB<span class="o">)</span>
    100% |████████████████████████████████| 9.2MB 120kB/s
Requirement already satisfied <span class="o">(</span>use <span class="nt">--upgrade</span> to upgrade<span class="o">)</span>: setuptools <span class="k">in</span> /usr/lib/python2.7/dist-packages <span class="o">(</span>from protobuf&gt;<span class="o">=</span>3.3.0-&gt;grpcio-tools<span class="o">==</span>1.7.0<span class="o">)</span>
Requirement already satisfied <span class="o">(</span>use <span class="nt">--upgrade</span> to upgrade<span class="o">)</span>: six&gt;<span class="o">=</span>1.9 <span class="k">in</span> /usr/lib/python2.7/dist-packages <span class="o">(</span>from protobuf&gt;<span class="o">=</span>3.3.0-&gt;grpcio-tools<span class="o">==</span>1.7.0<span class="o">)</span>
Requirement already satisfied <span class="o">(</span>use <span class="nt">--upgrade</span> to upgrade<span class="o">)</span>: enum34&gt;<span class="o">=</span>1.0.4 <span class="k">in</span> /usr/lib/python2.7/dist-packages <span class="o">(</span>from grpcio&gt;<span class="o">=</span>1.7.0-&gt;grpcio-tools<span class="o">==</span>1.7.0<span class="o">)</span>
Requirement already satisfied <span class="o">(</span>use <span class="nt">--upgrade</span> to upgrade<span class="o">)</span>: futures&gt;<span class="o">=</span>2.2.0 <span class="k">in</span> /usr/local/lib/python2.7/dist-packages <span class="o">(</span>from grpcio&gt;<span class="o">=</span>1.7.0-&gt;grpcio-tools<span class="o">==</span>1.7.0<span class="o">)</span>
Installing collected packages: grpcio, grpcio-tools, googleapis-common-protos
  Running setup.py install <span class="k">for </span>googleapis-common-protos ... <span class="k">done
</span>Successfully installed googleapis-common-protos-1.5.3 grpcio-1.14.1 grpcio-tools-1.7.0
You are using pip version 8.1.1, however version 18.0 is available.
You should consider upgrading via the <span class="s1">'pip install --upgrade pip'</span> command.
admin@devbox:~<span class="err">$</span>
admin@devbox:~<span class="err">$</span>


</code></pre></div></div>

<h3 id="view-proto-files-models">View .proto files (models)</h3>

<p>Let’s take a look at the <code class="highlighter-rouge">.proto</code> files that are packaged as part of the cloned repository:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>admin@devbox:$ cd service-layer-objmodel
admin@devbox:service-layer-objmodel$ pwd
/home/admin/service-layer-objmodel
admin@devbox:service-layer-objmodel$ cd grpc/protos/
admin@devbox:protos$ ls -l
total 116
-rw-rw-r-- 1 admin admin  4810 Aug 27 04:40 sl_bfd_common.proto
-rw-rw-r-- 1 admin admin  6918 Aug 27 04:40 sl_bfd_ipv4.proto
-rw-rw-r-- 1 admin admin  6916 Aug 27 04:40 sl_bfd_ipv6.proto
-rw-rw-r-- 1 admin admin 23285 Aug 27 04:40 sl_common_types.proto
-rw-rw-r-- 1 admin admin  6150 Aug 27 04:40 sl_global.proto
-rw-rw-r-- 1 admin admin  8068 Aug 27 04:40 sl_interface.proto
-rw-rw-r-- 1 admin admin 17521 Aug 27 04:40 sl_mpls.proto
-rw-rw-r-- 1 admin admin  9912 Aug 27 04:40 sl_route_common.proto
-rw-rw-r-- 1 admin admin  7203 Aug 27 04:40 sl_route_ipv4.proto
-rw-rw-r-- 1 admin admin  7165 Aug 27 04:40 sl_route_ipv6.proto
-rw-rw-r-- 1 admin admin   713 Aug 27 04:40 sl_version.proto
admin@devbox:protos$ ls
</code></pre></div></div>

<p>Briefly, these protobuf models cover the following capabilities:</p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">Functionality Vertical</th>
      <th style="text-align: left">Proto File</th>
      <th style="text-align: left">Supported RPCs</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">Common across Verticals</td>
      <td style="text-align: left"><code class="highlighter-rouge">sl_common_types.proto</code></td>
      <td style="text-align: left"><br />Defines common data structures for all verticals, such as Error codes, Operation codes (registration, notification etc.), and structures for XR interfaces and ip-addresses.<br /><br /></td>
    </tr>
    <tr>
      <td style="text-align: left">Common across Verticals</td>
      <td style="text-align: left"><code class="highlighter-rouge">sl_version.proto</code></td>
      <td style="text-align: left"><br />Contains an enum specifying the current Version of SL-API. <br />Current Version=<code class="highlighter-rouge">v0.0.1</code><br /><br /></td>
    </tr>
    <tr>
      <td style="text-align: left">Initialization</td>
      <td style="text-align: left"><code class="highlighter-rouge">sl_global.proto</code></td>
      <td style="text-align: left"><br />RPCs to fetch global information related to different functionality verticals and global limits and to create and mantain an initialization channel with IOS-XR service-layer over gRPC<br /><br /></td>
    </tr>
    <tr>
      <td style="text-align: left">Interface</td>
      <td style="text-align: left"><code class="highlighter-rouge">sl_interface.proto</code></td>
      <td style="text-align: left"><br />RPCs and data structures(messages) to get global and specific interface states, to enable/disable event notifications for specific interfaces and to register for interface state events<br /><br /></td>
    </tr>
    <tr>
      <td style="text-align: left">MPLS</td>
      <td style="text-align: left"><code class="highlighter-rouge">sl_mpls.proto</code></td>
      <td style="text-align: left"><br />RPCs to register against the MPLS vertical, allocate or delete label blocks and manipulate ILM (incoming Label Map) to forwarding function entries. It also defines all the data structures used by the MPLS vertical’s RPCs<br /><br /></td>
    </tr>
    <tr>
      <td style="text-align: left">Route</td>
      <td style="text-align: left"><code class="highlighter-rouge">sl_route_common.proto</code></td>
      <td style="text-align: left"><br />Defines data structures (messages) that are used by the Route vertical’s RPCs. These data structures include Registration objects (to register against the route vertical for a given VRF), VRF objects, and common Router and Path objects utilized by both IPv4 and IPv6 Route proto files.<br /><br /></td>
    </tr>
    <tr>
      <td style="text-align: left">Route</td>
      <td style="text-align: left"><code class="highlighter-rouge">sl_route_ipv4.proto</code></td>
      <td style="text-align: left"><br />Defines the RPC calls for IPv4 route changes (adding, deleting and getting IPv4 routes) and VRF registration - essential before one can manipulate routes in the IOS-XR RIB.<br /><br /></td>
    </tr>
    <tr>
      <td style="text-align: left">Route</td>
      <td style="text-align: left"><code class="highlighter-rouge">sl_route_ipv6.proto</code></td>
      <td style="text-align: left"><br />Defines the RPC calls for IPv6 route changes (adding, deleting and getting IPv6 routes) and VRF registration - essential before one can manipulate routes in the IOS-XR RIB.<br /><br /></td>
    </tr>
    <tr>
      <td style="text-align: left">BFD</td>
      <td style="text-align: left"><code class="highlighter-rouge">sl_bfd_common.proto</code></td>
      <td style="text-align: left"><br />Defines data structures (messages) that are used by the BFD vertical’s RPCs. These data structures include Registration objects (to register against the BFD vertical), State Objects (to identify a BFD event), Get objects and Set(Tx Interval Manipulation) Objects.<br /><br /></td>
    </tr>
    <tr>
      <td style="text-align: left">BFD</td>
      <td style="text-align: left"><code class="highlighter-rouge">sl_bfd_ipv4.proto</code></td>
      <td style="text-align: left"><br />Defines the RPCs for adding, deleting, updating, and retrieving BFD sessions: used for IPv4 BFD registrations, and BFD session operations and notifications.<br /><br /></td>
    </tr>
    <tr>
      <td style="text-align: left">BFD</td>
      <td style="text-align: left"><code class="highlighter-rouge">sl_bfd_ipv6.proto</code></td>
      <td style="text-align: left"><br />Defines the RPCs for adding, deleting, updating, and retrieving BFD sessions: used for IPv6 BFD registrations, and BFD session operations and notifications.<br /><br /></td>
    </tr>
  </tbody>
</table>

<h3 id="generate-python-bindings">Generate Python bindings</h3>

<p>Hop into the <code class="highlighter-rouge">grpc/python</code> directory under the cloned git repo. You will find the <code class="highlighter-rouge">gen-bindings.sh</code> script.</p>

<p>The contents of this script are dumped below:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>admin@devbox:python$ pwd
/home/admin/service-layer-objmodel/grpc/python
admin@devbox:python$
admin@devbox:python$ cat gen-bindings.sh
#!/bin/bash
#
# Copyright (c) 2016 by cisco Systems, Inc.
# All rights reserved.
#

#Clean up the Bindings first
rm -rf ./src/genpy/*
touch ./src/genpy/__init__.py

cd ../protos
printf "Generating Python bindings..."

for proto_file in *.proto
do
  python -m grpc_tools.protoc -I ./ --python_out=../python/src/genpy/ --grpc_python_out=../python/src/genpy/ $proto_file
done
cd ../python/src/genpy
2to3 -w * &gt;/dev/null 2&gt;&amp;1
echo "Done"
admin@devbox:python$

</code></pre></div></div>

<p>It can be seen that the <code class="highlighter-rouge">gen-bindings.sh</code> script first cleans up the existing <code class="highlighter-rouge">genpy/</code> directory where the bindings will be created and then proceeds to loop through the proto files running the <code class="highlighter-rouge">protoc</code> utility from the <code class="highlighter-rouge">grpc_tools</code> package. <br />
Once done, the <code class="highlighter-rouge">2to3</code> tool is run to convert all the generated bindings under <code class="highlighter-rouge">genpy/</code> from <code class="highlighter-rouge">only-python2</code> to <code class="highlighter-rouge">python2-and-python3</code> compatible.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>admin@devbox:python$
admin@devbox:python$ ./gen-bindings.sh
Generating Python bindings...Done
admin@devbox:python$

</code></pre></div></div>

<p>Once the <code class="highlighter-rouge">gen-bindings.sh</code> script has been run, jump to the <code class="highlighter-rouge">genpy</code> folder and you should see the generated bindings:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>admin@devbox:python$
admin@devbox:python$ pwd
/home/admin/service-layer-objmodel/grpc/python
admin@devbox:python$
admin@devbox:python$ cd src/genpy/
admin@devbox:genpy$
admin@devbox:genpy$ ls -l
total 384
-rw-rw-r-- 1 admin admin     0 Aug 27 03:30 __init__.py
-rw-rw-r-- 1 admin admin    83 Aug 27 03:30 sl_bfd_common_pb2_grpc.py
-rw-rw-r-- 1 admin admin 19890 Aug 27 03:30 sl_bfd_common_pb2.py
-rw-rw-r-- 1 admin admin  7457 Aug 27 03:30 sl_bfd_ipv4_pb2_grpc.py
-rw-rw-r-- 1 admin admin 25091 Aug 27 03:30 sl_bfd_ipv4_pb2.py
-rw-rw-r-- 1 admin admin  7457 Aug 27 03:30 sl_bfd_ipv6_pb2_grpc.py
-rw-rw-r-- 1 admin admin 25105 Aug 27 03:30 sl_bfd_ipv6_pb2.py
-rw-rw-r-- 1 admin admin    83 Aug 27 03:30 sl_common_types_pb2_grpc.py
-rw-rw-r-- 1 admin admin 44543 Aug 27 03:30 sl_common_types_pb2.py
-rw-rw-r-- 1 admin admin  3398 Aug 27 03:30 sl_global_pb2_grpc.py
-rw-rw-r-- 1 admin admin 16448 Aug 27 03:30 sl_global_pb2.py
-rw-rw-r-- 1 admin admin  7477 Aug 27 03:30 sl_interface_pb2_grpc.py
-rw-rw-r-- 1 admin admin 30041 Aug 27 03:30 sl_interface_pb2.py
-rw-rw-r-- 1 admin admin 10917 Aug 27 03:30 sl_mpls_pb2_grpc.py
-rw-rw-r-- 1 admin admin 45631 Aug 27 03:30 sl_mpls_pb2.py
-rw-rw-r-- 1 admin admin    83 Aug 27 03:30 sl_route_common_pb2_grpc.py
-rw-rw-r-- 1 admin admin 28853 Aug 27 03:30 sl_route_common_pb2.py
-rw-rw-r-- 1 admin admin 10197 Aug 27 03:30 sl_route_ipv4_pb2_grpc.py
-rw-rw-r-- 1 admin admin 20694 Aug 27 03:30 sl_route_ipv4_pb2.py
-rw-rw-r-- 1 admin admin 10197 Aug 27 03:30 sl_route_ipv6_pb2_grpc.py
-rw-rw-r-- 1 admin admin 20715 Aug 27 03:30 sl_route_ipv6_pb2.py
-rw-rw-r-- 1 admin admin    83 Aug 27 03:30 sl_version_pb2_grpc.py
-rw-rw-r-- 1 admin admin  2204 Aug 27 03:30 sl_version_pb2.py
admin@devbox:genpy$

</code></pre></div></div>

<p>It is important to understand what these <code class="highlighter-rouge">bindings</code> imply. These bindings are generated from the proto files that are described above and represent the <code class="highlighter-rouge">python</code> libraries that can be imported into your client code to provide the RPCs to be used to interact with the required functionality vertical.</p>

<p style="margin: 2em 0!important;padding: 0.85em;font-family: CiscoSans,Arial,Helvetica,sans-serif;font-size: 0.85em !important;text-indent: initial;background-color: #eff9ef;border-radius: 5px;box-shadow: 0 1px 1px rgba(0,127,171,0.25);"> Perfect! We are now ready to start running existing tutorials and analyze how to write our own.</p>

<h2 id="client-code-running-existing-tutorials">Client Code: Running existing tutorials</h2>

<p>In the cloned <code class="highlighter-rouge">service-layer-objmodel</code> git repo, there are several python tutorials showcasing how you can connect and utilize the various RPCs defined in the proto files (and therefore in the bindings we generated in the previous section).</p>

<h3 id="install-grpcio-and-ipaddress-packages">Install grpcio and ipaddress packages</h3>

<p>Before we try running the clients, install the necessary packages.
The <code class="highlighter-rouge">grpcio</code> package is a must to actually create a channel and connect to the router over gRPC. As mentioned in the previous section, the version of gRPC used is <code class="highlighter-rouge">1.7.0</code>. <br />
The <code class="highlighter-rouge">ipaddress</code> python package (or <code class="highlighter-rouge">py2-ipaddress</code> for python2) will be used to manage ip addresses in python for some of the client examples we intend to run.</p>

<h4 id="for-python2">For python2</h4>

<p>Version of <code class="highlighter-rouge">grpcio</code>=<code class="highlighter-rouge">1.7.0</code>. For python2, ipaddress module is actually <code class="highlighter-rouge">py2-ipaddress</code>. Use <code class="highlighter-rouge">pip2</code> to install packages for python2.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>admin@devbox:~<span class="err">$</span>
admin@devbox:~<span class="nv">$ </span><span class="nb">sudo </span>pip2 install <span class="nv">grpcio</span><span class="o">==</span>1.7.0 py2-ipaddress
The directory <span class="s1">'/home/admin/.cache/pip/http'</span> or its parent directory is not owned by the current user and the cache has been disabled. Please check the permissions and owner of that directory. If executing pip with <span class="nb">sudo</span>, you may want <span class="nb">sudo</span><span class="s1">'s -H flag.
The directory '</span>/home/admin/.cache/pip<span class="s1">' or its parent directory is not owned by the current user and caching wheels has been disabled. check the permissions and owner of that directory. If executing pip with sudo, you may want sudo'</span>s <span class="nt">-H</span> flag.
Collecting <span class="nv">grpcio</span><span class="o">==</span>1.7.0
  Downloading https://files.pythonhosted.org/packages/44/52/e5efd5f7adcfc41967691e296df8b1a96549c8a7f0fa5cf0b23204dcca07/grpcio-1.7.0-cp27-cp27mu-manylinux1_x86_64.whl <span class="o">(</span>5.7MB<span class="o">)</span>
    100% |████████████████████████████████| 5.7MB 201kB/s
Collecting py2-ipaddress
  Downloading https://files.pythonhosted.org/packages/06/f2/ff20f2d2fd4757be329c8ecb81e9e7fa3bec0b65445821e3a575410cf194/py2-ipaddress-3.4.1.tar.gz
Requirement already satisfied <span class="o">(</span>use <span class="nt">--upgrade</span> to upgrade<span class="o">)</span>: six&gt;<span class="o">=</span>1.5.2 <span class="k">in</span> /usr/lib/python2.7/dist-packages <span class="o">(</span>from <span class="nv">grpcio</span><span class="o">==</span>1.7.0<span class="o">)</span>
Requirement already satisfied <span class="o">(</span>use <span class="nt">--upgrade</span> to upgrade<span class="o">)</span>: enum34&gt;<span class="o">=</span>1.0.4 <span class="k">in</span> /usr/lib/python2.7/dist-packages <span class="o">(</span>from <span class="nv">grpcio</span><span class="o">==</span>1.7.0<span class="o">)</span>
Requirement already satisfied <span class="o">(</span>use <span class="nt">--upgrade</span> to upgrade<span class="o">)</span>: protobuf&gt;<span class="o">=</span>3.3.0 <span class="k">in</span> /usr/local/lib/python2.7/dist-packages <span class="o">(</span>from <span class="nv">grpcio</span><span class="o">==</span>1.7.0<span class="o">)</span>
Requirement already satisfied <span class="o">(</span>use <span class="nt">--upgrade</span> to upgrade<span class="o">)</span>: futures&gt;<span class="o">=</span>2.2.0 <span class="k">in</span> /usr/local/lib/python2.7/dist-packages <span class="o">(</span>from <span class="nv">grpcio</span><span class="o">==</span>1.7.0<span class="o">)</span>
Requirement already satisfied <span class="o">(</span>use <span class="nt">--upgrade</span> to upgrade<span class="o">)</span>: setuptools <span class="k">in</span> /usr/lib/python2.7/dist-packages <span class="o">(</span>from protobuf&gt;<span class="o">=</span>3.3.0-&gt;grpcio<span class="o">==</span>1.7.0<span class="o">)</span>
Installing collected packages: grpcio, py2-ipaddress
  Found existing installation: grpcio 1.14.1
    Uninstalling grpcio-1.14.1:
      Successfully uninstalled grpcio-1.14.1
  Running setup.py install <span class="k">for </span>py2-ipaddress ... <span class="k">done
</span>Successfully installed grpcio-1.7.0 py2-ipaddress-3.4.1
You are using pip version 8.1.1, however version 18.0 is available.
You should consider upgrading via the <span class="s1">'pip install --upgrade pip'</span> command.
admin@devbox:~<span class="err">$</span>
admin@devbox:~<span class="err">$</span>
</code></pre></div></div>

<h4 id="for-python3">For Python3</h4>

<p>Version of <code class="highlighter-rouge">grpcio</code>=<code class="highlighter-rouge">1.7.0</code>. For python3, ipaddress module is just <code class="highlighter-rouge">ipaddress</code>. Use <code class="highlighter-rouge">pip3</code> to install packages for python3.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>admin@devbox:~<span class="err">$</span>
admin@devbox:~<span class="nv">$ </span><span class="nb">sudo </span>pip3 install <span class="nv">grpcio</span><span class="o">==</span>1.7.0 ipaddress
The directory <span class="s1">'/home/admin/.cache/pip/http'</span> or its parent directory is not owned by the current user and the cache has been disabled. Please check the permissions and owner of that directory. If executing pip with <span class="nb">sudo</span>, you may want <span class="nb">sudo</span><span class="s1">'s -H flag.
The directory '</span>/home/admin/.cache/pip<span class="s1">' or its parent directory is not owned by the current user and caching wheels has been disabled. check the permissions and owner of that directory. If executing pip with sudo, you may want sudo'</span>s <span class="nt">-H</span> flag.
Collecting <span class="nv">grpcio</span><span class="o">==</span>1.7.0
  Downloading https://files.pythonhosted.org/packages/17/69/0c06ee99a7df3814520c94014a6e0b2ee4b997f88970aca9e4c072b5672a/grpcio-1.7.0-cp35-cp35m-manylinux1_x86_64.whl <span class="o">(</span>5.7MB<span class="o">)</span>
    100% |████████████████████████████████| 5.7MB 7.3MB/s
Collecting ipaddress
  Downloading https://files.pythonhosted.org/packages/fc/d0/7fc3a811e011d4b388be48a0e381db8d990042df54aa4ef4599a31d39853/ipaddress-1.0.22-py2.py3-none-any.whl
Requirement already satisfied: six&gt;<span class="o">=</span>1.5.2 <span class="k">in</span> /usr/lib/python3/dist-packages <span class="o">(</span>from <span class="nv">grpcio</span><span class="o">==</span>1.7.0<span class="o">)</span> <span class="o">(</span>1.10.0<span class="o">)</span>
Requirement already satisfied: protobuf&gt;<span class="o">=</span>3.3.0 <span class="k">in</span> /usr/local/lib/python3.5/dist-packages <span class="o">(</span>from <span class="nv">grpcio</span><span class="o">==</span>1.7.0<span class="o">)</span> <span class="o">(</span>3.6.1<span class="o">)</span>
Requirement already satisfied: setuptools <span class="k">in</span> /usr/lib/python3/dist-packages <span class="o">(</span>from protobuf&gt;<span class="o">=</span>3.3.0-&gt;grpcio<span class="o">==</span>1.7.0<span class="o">)</span> <span class="o">(</span>20.7.0<span class="o">)</span>
Installing collected packages: grpcio, ipaddress
Successfully installed grpcio-1.7.0 ipaddress-1.0.22
You are using pip version 10.0.1, however version 18.0 is available.
You should consider upgrading via the <span class="s1">'pip install --upgrade pip'</span> command.
admin@devbox:~<span class="err">$</span>
admin@devbox:~<span class="err">$</span>


</code></pre></div></div>

<h3 id="running-pre-packaged-tutorials">Running pre-packaged tutorials</h3>

<p>Let’s run some of the representative tutorials that are packaged along with the <code class="highlighter-rouge">service-layer-objmodel</code> git repo and see if things are working well. We will also run some commands on the router r1 (that we intend to connect to) in order to understand the effect of programming IOS-XR using the service-layer API.</p>

<h4 id="list-the-existing-tutorials">List the existing tutorials</h4>

<p>The existing tutorials are shown below in the <code class="highlighter-rouge">grpc/python/src/tutorial</code> directory under the git repo <code class="highlighter-rouge">service-layer-objmodel</code>.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>admin@devbox:python<span class="nv">$ </span><span class="nb">pwd</span>
/home/admin/service-layer-objmodel/grpc/python
admin@devbox:python<span class="err">$</span>
admin@devbox:python<span class="err">$</span>
admin@devbox:python<span class="err">$</span>
admin@devbox:python<span class="nv">$ </span><span class="nb">cd </span>src/tutorial/
admin@devbox:tutorial<span class="err">$</span>
admin@devbox:tutorial<span class="err">$</span>
admin@devbox:tutorial<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-l</span>
total 88
<span class="nt">-rw-rw-r--</span> 1 admin admin  5823 Aug 27 04:40 client_init.py
drwxrwxr-x 2 admin admin  4096 Aug 27 04:40 grpc_beta
<span class="nt">-rw-rw-r--</span> 1 admin admin    72 Aug 27 04:40 __init__.py
<span class="nt">-rw-rw-r--</span> 1 admin admin 12698 Aug 27 04:40 interface.py
<span class="nt">-rw-rw-r--</span> 1 admin admin 10329 Aug 27 04:40 mpls_ilm.py
<span class="nt">-rw-rw-r--</span> 1 admin admin  5435 Aug 27 04:40 quickstart.py
<span class="nt">-rw-rw-r--</span> 1 admin admin 14211 Aug 27 04:40 README.md
<span class="nt">-rw-rw-r--</span> 1 admin admin 12857 Aug 27 04:40 route.py
<span class="nt">-rw-rw-r--</span> 1 admin admin  3617 Aug 27 04:40 vrf.py
admin@devbox:tutorial<span class="err">$</span>
admin@devbox:tutorial<span class="err">$</span>

</code></pre></div></div>

<blockquote class="notice--warning">
  <p>All the tutorials described below, expect the following environment variables to be set before running them:</p>
  <ul>
    <li>SERVER_IP: IP address over which the router’s gRPC server is reachable</li>
    <li>SERVER_PORT: TCP port over which the router’s gRPC server is reachable <br />
To set these variables, simply export them in the shell of the admin box before running the &gt;tutorials (The tutorials will ask you to if you miss this):
      <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>admin@devbox:tutorial$
admin@devbox:tutorial$ export SERVER_IP=10.10.20.170
admin@devbox:tutorial$ export SERVER_PORT=57021
admin@devbox:tutorial$
</code></pre></div>      </div>
    </li>
  </ul>
</blockquote>

<p>These tutorials cover the following use cases:</p>

<h4 id="basic-client-initialization-client_initpy">Basic Client Initialization: client_init.py</h4>

<p>This tutorial utilizes the initialization RPC to set up a <code class="highlighter-rouge">notification</code> channel with the service-layer gRPC server running on the router. This <code class="highlighter-rouge">notification</code> channel is used by the client to be notified of any server error conditions or any disconnect messages. <strong>You canNOT utilize any of the service-layer functionality verticals if you don’t keep a notification channel active.</strong></p>

<p>This is usually done by initiating the notification channel in a separate <code class="highlighter-rouge">thread</code> inside your code, so that the rest of code can continue to execute while the notification channel remains active within the thread.
Most modern programming languages (certainly python, c++, golang) have concepts of parallel processes such as threads to enable this functionality.</p>

<p><code class="highlighter-rouge">client_init.py</code> will simply connect, set up a channel and disconnect. Its init code will be run inside a separate thread in the next set of tutorials that leverage it.</p>

<p style="margin: 2em 0!important;padding: 0.85em;font-family: CiscoSans,Arial,Helvetica,sans-serif;font-size: 0.85em !important;text-indent: initial;background-color: #e6f2f7;border-radius: 5px;box-shadow: 0 1px 1px rgba(0,127,171,0.25);">Version `v0.0.1` of the Service-Layer API supports only one client connection at a time. So if another client connects to the service-layer (version `v0.0.1`), a disconnect message will be sent to the existing client over the notification channel </p>

<p>Run <code class="highlighter-rouge">client_init.py</code>:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>admin@devbox:tutorial$
admin@devbox:tutorial$
admin@devbox:tutorial$ python3 client_init.py
Using GRPC Server IP(10.10.20.170) Port(57021)
Global thread spawned
Server Returned 0x502, Version 0.0.0  
Successfully Initialized, connection established!
Max VRF Name Len     : 33
Max Iface Name Len   : 64
Max Paths per Entry  : 64
Max Prim per Entry   : 32
Max Bckup per Entry  : 32
Max Labels per Entry : 3
Min Prim Path-id     : 1
Max Prim Path-id     : 64
Min Bckup Path-id    : 65
Max Bckup Path-id    : 128
Max Remote Bckup Addr: 2
admin@devbox:tutorial$
</code></pre></div></div>

<p>Perfect, the client was able to connect to the Service-layer, set up a channel, glean some global limits associated with the different functionality verticals and dump them, before disconnecting.</p>

<p> <br /></p>
<h4 id="registerunregister-against-the-route-vertical-vrfpy">Register/Unregister against the Route Vertical: vrf.py</h4>
<p><br />
This tutorial utilizes the <code class="highlighter-rouge">client_init.py</code> code to maintain the notification channel for it while it proceeds to register against a particular vrf (<code class="highlighter-rouge">vrf default</code>). This accomplishes registration for the <code class="highlighter-rouge">Route</code> vertical described earlier.
Only post registration with the Route vertical can the RIB manipulations be carried out.</p>

<p style="margin: 2em 0!important;padding: 0.85em;font-family: CiscoSans,Arial,Helvetica,sans-serif;font-size: 0.85em !important;text-indent: initial;background-color: #e6f2f7;border-radius: 5px;box-shadow: 0 1px 1px rgba(0,127,171,0.25);">One must register against a functionality vertical first. Only post registration, would the RPCs for that vertical work.</p>

<p>Run <code class="highlighter-rouge">vrf.py</code>:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>admin@devbox:tutorial$
admin@devbox:tutorial$ python3 vrf.py
Using GRPC Server IP(10.10.20.170) Port(57021)
Global thread spawned
Server Returned 0x502, Version 0.0.0
Successfully Initialized, connection established!
Max VRF Name Len     : 33
Max Iface Name Len   : 64
Max Paths per Entry  : 64
Max Prim per Entry   : 32
Max Bckup per Entry  : 32
Max Labels per Entry : 3
Min Prim Path-id     : 1
Max Prim Path-id     : 64
Min Bckup Path-id    : 65
Max Bckup Path-id    : 128
Max Remote Bckup Addr: 2
VRF SL_REGOP_REGISTER Success!
VRF SL_REGOP_EOF Success!
VRF SL_REGOP_UNREGISTER Success!
admin@devbox:tutorial$
</code></pre></div></div>

<p>The initial dump is the same as the earlier run of <code class="highlighter-rouge">client_init.py</code> since <code class="highlighter-rouge">vrf.py</code> utilizes <code class="highlighter-rouge">client_init.py</code>.  The last set of messages show that the client was able to:</p>
<ul>
  <li><strong>Successfully Register</strong> for the Route vertical (for vrf: <code class="highlighter-rouge">default</code>)</li>
  <li><strong>Send an EOF</strong> (used to flush out stale routes - marked by the registration process- should remind folks of the  Mark and Sweep technique used in Garbage Collection algorithms. This is utilized whenever controllers/clients intend to resync routes with the IOS-XR RIB in the event of either a client or server failure.)</li>
  <li><strong>Successfully Unregister</strong> for the Route Vertical (used to disconnect and flush out all the routes from the particular vrf)</li>
</ul>

<p> <br /></p>

<h4 id="add-routes-to-ios-xr-rib-quickstartpy">Add Routes to IOS-XR RIB: quickstart.py</h4>
<p><br />
The <code class="highlighter-rouge">quickstart.py</code> tutorial uses <code class="highlighter-rouge">vrf.py</code> (which in turn uses <code class="highlighter-rouge">client_init.py</code> as mentioned above) to register against the Route vertical. It then utilizes RPCs in the IPv4 Route vertical to program IPv4 routes into the IOS-XR RIB.</p>

<p>Run <code class="highlighter-rouge">quickstart.py</code>:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> admin@devbox:tutorial$ python3 quickstart.py
 Using GRPC Server IP(10.10.20.170) Port(57021)
 Global thread spawned
 Server Returned 0x502, Version 0.0.0
 Successfully Initialized, connection established!
 Max VRF Name Len     : 33
 Max Iface Name Len   : 64
 Max Paths per Entry  : 64
 Max Prim per Entry   : 32
 Max Bckup per Entry  : 32
 Max Labels per Entry : 3
 Min Prim Path-id     : 1
 Max Prim Path-id     : 64
 Min Bckup Path-id    : 65
 Max Bckup Path-id    : 128
 Max Remote Bckup Addr: 2
 VRF SL_REGOP_REGISTER Success!
 VRF SL_REGOP_EOF Success!
 Route SL_OBJOP_ADD Success!
 admin@devbox:tutorial$

</code></pre></div></div>

<p>Perfect! The first few messages would remind you of the output from the <code class="highlighter-rouge">vrf.py</code> tutorial above. We do not Unregister here, but instead utilize the Route vertical to push some route objects into the IOS-XR RIB.</p>

<p>To verify this, ssh into the router and do a dump of the RIB using <code class="highlighter-rouge">show route</code>:</p>

<p style="margin: 2em 0!important;padding: 0.85em;font-family: CiscoSans,Arial,Helvetica,sans-serif;font-size: 0.85em !important;text-indent: initial;background-color: #e6f2f7;border-radius: 5px;box-shadow: 0 1px 1px rgba(0,127,171,0.25);"><b>Username</b>: admin<br /><b>Password</b>: admin<br /><b>SSH port</b>: 2221
 </p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> Laptop-terminal$ ssh -p 2221 admin@10.10.20.170
 ------------------------------------------------------------------------
 Router 1 (Cisco IOS XR Sandbox)
 ------------------------------------------------------------------------
 Password:

 RP/0/RP0/CPU0:r1#
 RP/0/RP0/CPU0:r1#show  route
 Sun Sep  2 00:49:39.882 UTC

 Codes: C - connected, S - static, R - RIP, B - BGP, (&gt;) - Diversion path
        D - EIGRP, EX - EIGRP external, O - OSPF, IA - OSPF inter area
        N1 - OSPF NSSA external type 1, N2 - OSPF NSSA external type 2
        E1 - OSPF external type 1, E2 - OSPF external type 2, E - EGP
        i - ISIS, L1 - IS-IS level-1, L2 - IS-IS level-2
        ia - IS-IS inter area, su - IS-IS summary null, * - candidate default
        U - per-user static route, o - ODR, L - local, G  - DAGR, l - LISP
        A - access/subscriber, a - Application route
        M - mobile route, r - RPL, t - Traffic Engineering, (!) - FRR Backup path

 Gateway of last resort is 192.168.122.1 to network 0.0.0.0

 S*   0.0.0.0/0 [1/0] via 192.168.122.1, 5d13h
 a    20.0.0.0/24 [2/0] via 10.10.10.1, 00:04:31, GigabitEthernet0/0/0/0
                  [2/0] via 10.10.10.2, 00:04:31, GigabitEthernet0/0/0/0
 a    20.0.1.0/24 [2/0] via 10.10.10.1, 00:04:31, GigabitEthernet0/0/0/0
                  [2/0] via 10.10.10.2, 00:04:31, GigabitEthernet0/0/0/0
 a    20.0.2.0/24 [2/0] via 10.10.10.1, 00:04:31, GigabitEthernet0/0/0/0
                  [2/0] via 10.10.10.2, 00:04:31, GigabitEthernet0/0/0/0
 a    20.0.3.0/24 [2/0] via 10.10.10.1, 00:04:31, GigabitEthernet0/0/0/0
                  [2/0] via 10.10.10.2, 00:04:31, GigabitEthernet0/0/0/0
 a    20.0.4.0/24 [2/0] via 10.10.10.1, 00:04:31, GigabitEthernet0/0/0/0
                  [2/0] via 10.10.10.2, 00:04:31, GigabitEthernet0/0/0/0
 a    20.0.5.0/24 [2/0] via 10.10.10.1, 00:04:31, GigabitEthernet0/0/0/0
                  [2/0] via 10.10.10.2, 00:04:31, GigabitEthernet0/0/0/0
 a    20.0.6.0/24 [2/0] via 10.10.10.1, 00:04:31, GigabitEthernet0/0/0/0
                  [2/0] via 10.10.10.2, 00:04:31, GigabitEthernet0/0/0/0
 a    20.0.7.0/24 [2/0] via 10.10.10.1, 00:04:31, GigabitEthernet0/0/0/0
                  [2/0] via 10.10.10.2, 00:04:31, GigabitEthernet0/0/0/0
 a    20.0.8.0/24 [2/0] via 10.10.10.1, 00:04:31, GigabitEthernet0/0/0/0
                  [2/0] via 10.10.10.2, 00:04:31, GigabitEthernet0/0/0/0
 a    20.0.9.0/24 [2/0] via 10.10.10.1, 00:04:31, GigabitEthernet0/0/0/0
                  [2/0] via 10.10.10.2, 00:04:31, GigabitEthernet0/0/0/0
 C    192.168.122.0/24 is directly connected, 5d13h, MgmtEth0/RP0/CPU0/0
 L    192.168.122.21/32 is directly connected, 5d13h, MgmtEth0/RP0/CPU0/0
 RP/0/RP0/CPU0:r1#

</code></pre></div></div>

<p style="margin: 2em 0!important;padding: 0.85em;font-family: CiscoSans,Arial,Helvetica,sans-serif;font-size: 0.85em !important;text-indent: initial;background-color: #eff9ef;border-radius: 5px;box-shadow: 0 1px 1px rgba(0,127,171,0.25);">Notice the `a` routes in the RIB. These were the routes pushed into the RIB by the `quickstart.py` client.
 </p>

<p> <br /></p>

<h4 id="add-routes-to-ios-xr-rib-routepy">Add Routes to IOS-XR RIB: route.py</h4>
<p><br />
This tutorial is a combination of <code class="highlighter-rouge">client_init.py</code>, <code class="highlighter-rouge">vrf.py</code> and <code class="highlighter-rouge">quickstart.py</code> into a single piece of code. We will not run this tutorial as part of the lab but it useful to look at to see how to combine the 3 pieces of code above.</p>

<p> <br /></p>

<h4 id="register-and-listen-for-interface-state-events-interfacepy">Register and Listen for interface state events: interface.py</h4>
<p><br />
This tutorial showcases how to register against the interface vertical, set up event streams for a certain set of interfaces and then start thread to receive notifications of interface events as we shut/no-shut registered interfaces.</p>

<p>Run <code class="highlighter-rouge">interface.py</code>:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>admin@devbox:tutorial$ python3 interface.py
Using GRPC Server IP(10.10.20.170) Port(57021)
Global thread spawned
Server Returned 0x502, Version 0.0.0
Successfully Initialized, connection established!
Max VRF Name Len     : 33
Max Iface Name Len   : 64
Max Paths per Entry  : 64
Max Prim per Entry   : 32
Max Bckup per Entry  : 32
Max Labels per Entry : 3
Min Prim Path-id     : 1
Max Prim Path-id     : 64
Min Bckup Path-id    : 65
Max Bckup Path-id    : 128
Max Remote Bckup Addr: 2
ErrStatus {
}

ErrStatus {
}

StatusSummary {
}

ErrStatus {
}
MaxInterfacesPerBatch: 1024

Eof: true
ErrStatus {
}
Entries {
 SLIfInfo {
   Name: "GigabitEthernet0/0/0/0"
 }
}
Entries {
 SLIfInfo {
   Name: "GigabitEthernet0/0/0/1"
 }
}
Entries {
 SLIfInfo {
   Name: "MgmtEth0/RP0/CPU0/0"
 }
}

Starting listener for interface events

</code></pre></div></div>

<p>We register for the state events of three interfaces, namely:  <code class="highlighter-rouge">GigabitEthernet0/0/0/0</code>, <code class="highlighter-rouge">GigabitEthernet0/0/0/1</code> and <code class="highlighter-rouge">MgmtEth0/RP0/CPU0/0</code>.</p>

<p>You will notice that the client is still running, because it is listening for interface state events in a persistent thread. Let’s trigger the shut/no-shut of interface <code class="highlighter-rouge">GigabitEthernet0/0/0/0</code> and see how the client reacts.</p>

<p>Connect to the router <code class="highlighter-rouge">r1</code> in a separate terminal while the client is running and shut down interface Gig0/0/0/0:</p>

<p style="margin: 2em 0!important;padding: 0.85em;font-family: CiscoSans,Arial,Helvetica,sans-serif;font-size: 0.85em !important;text-indent: initial;background-color: #e6f2f7;border-radius: 5px;box-shadow: 0 1px 1px rgba(0,127,171,0.25);"><b>Username</b>: admin<br /><b>Password</b>: admin<br /><b>SSH port</b>: 2221
</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Laptop-terminal$ ssh -p 2221 admin@10.10.20.170
------------------------------------------------------------------------
Router 1 (Cisco IOS XR Sandbox)
------------------------------------------------------------------------
Password:

RP/0/RP0/CPU0:r1#
RP/0/RP0/CPU0:r1#
RP/0/RP0/CPU0:r1#
RP/0/RP0/CPU0:r1#conf t
Sun Sep  2 01:24:29.685 UTC
RP/0/RP0/CPU0:r1(config)#int  gigabitEthernet 0/0/0/0
RP/0/RP0/CPU0:r1(config-if)#shut
RP/0/RP0/CPU0:r1(config-if)#commit
Sun Sep  2 01:24:35.402 UTC
RP/0/RP0/CPU0:r1(config-if)#
</code></pre></div></div>

<p>Hop back to the running client, and you should notice the following message show up:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Received HeartBeat
Received HeartBeat
EventType: SL_INTERFACE_EVENT_TYPE_INTERFACE_INFO
Info {
 SLIfInfo {
   Name: "GigabitEthernet0/0/0/0"
 }
 IfState: SL_IF_STATE_DOWN
 SeqNum: 11
}

</code></pre></div></div>

<p>The <code class="highlighter-rouge">Received HeartBeat</code> messages show up as the client receives heartbeats periodically from the Server.  The event <code class="highlighter-rouge">SL_INTERFACE_EVENT_TYPE_INTERFACE_INFO</code> gives us more information on the type of interface event received:</p>
<ul>
  <li>It is for the interface <code class="highlighter-rouge">GigabitEthernet0/0/0/0</code> and</li>
  <li>It was a <code class="highlighter-rouge">DOWN</code> event: <code class="highlighter-rouge">IfState: SL_IF_STATE_DOWN</code></li>
  <li>The sequence number: <code class="highlighter-rouge">SeqNum: 11</code> illustrates the sequence number of this event message - can be used to correlate events in a sequence of interface events (for e.g. in case of flapping interfaces).</li>
</ul>

<p>Similarly, no-shut the interface <code class="highlighter-rouge">GigabitEthernet0/0/0/0</code> on the router and notice the <code class="highlighter-rouge">UP</code> event being streamed to the client:</p>

<p><strong>Router <code class="highlighter-rouge">r1</code>:</strong></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>RP/0/RP0/CPU0:r1#
RP/0/RP0/CPU0:r1#conf t
Sun Sep  2 01:24:29.685 UTC
RP/0/RP0/CPU0:r1(config)#int  gigabitEthernet 0/0/0/0
RP/0/RP0/CPU0:r1(config-if)#no shut
RP/0/RP0/CPU0:r1(config-if)#commit
Sun Sep  2 01:24:35.402 UTC
RP/0/RP0/CPU0:r1(config-if)#
</code></pre></div></div>

<p><strong>Devbox:</strong></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Received HeartBeat
Received HeartBeat
EventType: SL_INTERFACE_EVENT_TYPE_INTERFACE_INFO
Info {
  SLIfInfo {
    Name: "GigabitEthernet0/0/0/0"
  }
  IfState: SL_IF_STATE_UP
  SeqNum: 12
}


</code></pre></div></div>

<p> <br /></p>

<h4 id="allocate-local-labels-and-create-ilm-entries-mpls_ilmpy">Allocate Local labels and Create ILM entries: mpls_ilm.py</h4>
<p><br />
This tutorial showcases how to register against the mpls vertical, allocate label blocks and then utilize these labels to create ILM (incoming label map) to forwarding function entries.</p>

<p>Run <code class="highlighter-rouge">mpls_ilm.py</code>:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>admin@devbox:tutorial$ python3 mpls_ilm.py
Using GRPC Server IP(10.10.20.170) Port(57021)
Global thread spawned
Server Returned 0x502, Version 0.0.0
Successfully Initialized, connection established!
Max VRF Name Len     : 33
Max Iface Name Len   : 64
Max Paths per Entry  : 64
Max Prim per Entry   : 32
Max Bckup per Entry  : 32
Max Labels per Entry : 3
Min Prim Path-id     : 1
Max Prim Path-id     : 64
Min Bckup Path-id    : 65
Max Bckup Path-id    : 128
Max Remote Bckup Addr: 2
MPLS SL_OBJOP_ADD Success!
MPLS SL_OBJOP_UPDATE Success!
admin@devbox:tutorial$

</code></pre></div></div>

<p>Hop onto router <code class="highlighter-rouge">r1</code> and dump the allocated label blocks:</p>

<p style="margin: 2em 0!important;padding: 0.85em;font-family: CiscoSans,Arial,Helvetica,sans-serif;font-size: 0.85em !important;text-indent: initial;background-color: #e6f2f7;border-radius: 5px;box-shadow: 0 1px 1px rgba(0,127,171,0.25);"><b>Username</b>: admin<br /><b>Password</b>: admin<br /><b>SSH port</b>: 2221
</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Laptop-terminal$ ssh -p 2221 admin@10.10.20.170
------------------------------------------------------------------------
Router 1 (Cisco IOS XR Sandbox)
------------------------------------------------------------------------
Password:

RP/0/RP0/CPU0:r1#
RP/0/RP0/CPU0:r1#
RP/0/RP0/CPU0:r1#
RP/0/RP0/CPU0:r1#show  mpls label table
Sun Sep  2 01:35:21.489 UTC
Table Label   Owner                           State  Rewrite
----- ------- ------------------------------- ------ -------
0     0       LSD(A)                          InUse  Yes
0     1       LSD(A)                          InUse  Yes
0     2       LSD(A)                          InUse  Yes
0     13      LSD(A)                          InUse  Yes
0     30000   Static(A):Service-layer         InUse  No
0     31000   Static(A):Service-layer         InUse  No
0     32000   Static(A):Service-layer         InUse  No
0     33000   Static(A):Service-layer         InUse  No
0     34000   Static(A):Service-layer         InUse  Yes
0     35000   Static(A):Service-layer         InUse  No
0     36000   Static(A):Service-layer         InUse  No
0     37000   Static(A):Service-layer         InUse  No
0     38000   Static(A):Service-layer         InUse  No
0     39000   Static(A):Service-layer         InUse  No
RP/0/RP0/CPU0:r1#
</code></pre></div></div>

<p>Notice the labels marked <code class="highlighter-rouge">Static(A):Service-layer</code> ? These were allocated by the <code class="highlighter-rouge">mpls_ilm.py</code> client.</p>

<p>Now dump the <code class="highlighter-rouge">mpls forwarding</code> entries on the router:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>RP/0/RP0/CPU0:r1#show  mpls  forwarding
Sun Sep  2 01:38:58.400 UTC
Local  Outgoing    Prefix             Outgoing     Next Hop        Bytes       
Label  Label       or ID              Interface                    Switched    
------ ----------- ------------------ ------------ --------------- ------------
34000  10065       SR Pfx (idx 0)     Gi0/0/0/1    12.1.1.20       0           
RP/0/RP0/CPU0:r1#
</code></pre></div></div>

<p>Perfect! This showcases a <code class="highlighter-rouge">SWAP</code> entry created by the client. This entry will receive any packet with incoming-label=<code class="highlighter-rouge">34000</code>, swap it with label=<code class="highlighter-rouge">10065</code> and forward it to the nexthop interface <code class="highlighter-rouge">GigabitEthernet0/0/0/1</code> and nexthop address=<code class="highlighter-rouge">12.1.1.20</code>.</p>

<p>Of course, you get to play with the usual mpls label operations like : <code class="highlighter-rouge">PUSH</code>, <code class="highlighter-rouge">POP_AND_FORWARD</code>, <code class="highlighter-rouge">POP_AND_LOOKUP_IPV4</code> and <code class="highlighter-rouge">POP_AND_LOOKUP_IPV6</code> to create ILM entries based on your use case.</p>

<p style="margin: 2em 0!important;padding: 0.85em;font-family: CiscoSans,Arial,Helvetica,sans-serif;font-size: 0.85em !important;text-indent: initial;background-color: #eff9ef;border-radius: 5px;box-shadow: 0 1px 1px rgba(0,127,171,0.25);">Now that we've seen the various service-layer API clients in action and their effects on the Router, let's break down the actual code in the `route.py` tutorial to learn how to write a client from scratch.
</p>
