<aside class="sidebar__right">
<nav class="toc">
    <header><h4 class="nav__title"><i class="fa fa-file-text"></i> On This Page</h4></header>
<ul class="toc__menu" id="markdown-toc">
  <li><a href="#to-know-more" id="markdown-toc-to-know-more">To Know More</a></li>
  <li><a href="#ansible-netconf_config-module" id="markdown-toc-ansible-netconf_config-module">Ansible netconf_config module</a>    <ul>
      <li><a href="#install-ncclient" id="markdown-toc-install-ncclient">Install ncclient</a></li>
      <li><a href="#execute-the-ansible-playbook-to-configure-bgp" id="markdown-toc-execute-the-ansible-playbook-to-configure-bgp">Execute the Ansible playbook to configure BGP</a></li>
      <li><a href="#check-the-bgp-configuration-on-the-routers" id="markdown-toc-check-the-bgp-configuration-on-the-routers">Check the BGP configuration on the routers</a></li>
    </ul>
  </li>
  <li><a href="#ydk" id="markdown-toc-ydk">YDK</a>    <ul>
      <li><a href="#ydk-python-script-to-configure-model-driven-telemetry" id="markdown-toc-ydk-python-script-to-configure-model-driven-telemetry">YDK python script to configure Model-Driven Telemetry</a></li>
      <li><a href="#execute-the-ydk-script" id="markdown-toc-execute-the-ydk-script">Execute the YDK script:</a></li>
      <li><a href="#check-the-telemetry-configuration-on-router-r1" id="markdown-toc-check-the-telemetry-configuration-on-router-r1">Check the Telemetry configuration on router r1</a></li>
      <li><a href="#verify-that-the-telemetry-sensor-paths-are-resolved" id="markdown-toc-verify-that-the-telemetry-sensor-paths-are-resolved">Verify that the Telemetry sensor-paths are resolved</a></li>
    </ul>
  </li>
  <li><a href="#writing-your-own-python-telemetry-client" id="markdown-toc-writing-your-own-python-telemetry-client">Writing your own Python Telemetry client</a>    <ul>
      <li><a href="#install-dependencies-for-the-grpc-telemetry-client" id="markdown-toc-install-dependencies-for-the-grpc-telemetry-client">Install dependencies for the gRPC telemetry client</a></li>
      <li><a href="#clone-the-telemetry-grpc-collectors-git-repo" id="markdown-toc-clone-the-telemetry-grpc-collectors-git-repo">Clone the Telemetry gRPC collectors git repo</a></li>
      <li><a href="#build-the-bindings-for-model-driven-telemetry-grpc-clients" id="markdown-toc-build-the-bindings-for-model-driven-telemetry-grpc-clients">Build the Bindings for Model Driven Telemetry gRPC clients</a></li>
      <li><a href="#running-a-simple-python-telemetry-client" id="markdown-toc-running-a-simple-python-telemetry-client">Running a simple python Telemetry client</a></li>
    </ul>
  </li>
</ul>

  </nav>
</aside>

<h2 id="to-know-more">To Know More</h2>

<p>There are several tools in the industry that allow you to play around with YANG models on IOS-XR and other Network OS stacks.</p>

<p>In this lab we will look at a few of them:</p>

<ul>
  <li>
    <p>The Ansible <code class="highlighter-rouge">netconf_config</code> module to configure a BGP session on the routers. <a href="https://docs.ansible.com/ansible/2.4/netconf_config_module.html">https://docs.ansible.com/ansible/2.4/netconf_config_module.html</a></p>
  </li>
  <li>Yang Development Kit (YDK) to configure Telemetry and interfaces on the routers: <a href="http://ydk.io">http://ydk.io</a></li>
  <li>Your own python Telemetry client which we will use to extract python data coming from YANG paths set up by YDK:</li>
</ul>
<p><a href="https://learninglabs.cisco.com/tracks/iosxr-programmability/iosxr-streaming-telemetry/03-iosxr-02-telemetry-python/step/1">https://learninglabs.cisco.com/tracks/iosxr-programmability/iosxr-streaming-telemetry/03-iosxr-02-telemetry-python/step/1</a>. Also, a lot more on Telemetry here: <a href="https://xrdocs.io/telemetry/">https://xrdocs.io/telemetry/</a></p>

<blockquote class="notice--info">
  <p>Connect to your Pod first! Make sure your Anyconnect VPN connection to the Pod assigned to you is active.</p>

  <p>If you haven’t connected yet, check out the instructions to do so here:
<a href="https://sevt-sp.github.io/xr-programmability-lab/connect-to-pods/">https://sevt-sp.github.io/xr-programmability-lab/connect-to-pods/</a></p>

  <p>Once you’re connected, use the following instructions to connect to the individual nodes.
The instructions in the workshop will simply refer to the Name of the box to connect without
repeating the connection details and credentials. So refer back to this list when you need it.</p>

  <p>The 3 nodes in the topology are:</p>

  <p style="font-size: 16px;"><b>Development Linux System (DevBox)</b></p>
  <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> IP Address: 10.10.20.170
 Username/Password: [admin/admin]
 SSH Port: 2211
</code></pre></div>  </div>

  <p style="font-size: 16px;"><b>IOS-XRv9000 R1: (Router r1)</b></p>

  <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>IP Address: 10.10.20.170  
Username/Password: [admin/admin]   
Management IP: 10.10.20.170  
XR SSH Port: 2221    
NETCONF Port: 8321   
gRPC Port: 57021  
XR-Bash SSH Port: 2222    
</code></pre></div>  </div>

  <p style="font-size: 16px;"><b>IOS-XRv9000 R2:  (Router r2)</b></p>

  <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>IP Address: 10.10.20.170   
Username/Password: [admin/admin]   
Management IP: 10.10.20.170   
XR SSH Port: 2231    
NETCONF Port: 8331   
gRPC Port: 57031    
XR-Bash SSH Port: 2232
</code></pre></div>  </div>
</blockquote>

<p>The Topology in use is shown below:
<img src="/images/topology_devnet.png" alt="topology_devnet.png" /></p>

<h2 id="ansible-netconf_config-module">Ansible netconf_config module</h2>

<p>Hop into the devbox and browse to the ansible directory:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>AKSHSHAR-M-33WP:~ akshshar$ ssh -p 2211 admin@10.10.20.170
admin@10.10.20.170's password: 
Last login: Tue Jan 29 18:35:38 2019 from 192.168.122.1
admin@devbox:~$ 
admin@devbox:~$ 
admin@devbox:~$ cd xr-programmability-lab-code/
admin@devbox:xr-programmability-lab-code$ ls
ansible  README.md  ztp_hooks
admin@devbox:xr-programmability-lab-code$ cd ansible/
admin@devbox:ansible$ ls
ansible_hosts  configure_bgp_netconf.yml  docker_bringup.yml  execute_python_ztp.yml  openr  set_ipv6_route.sh  xml
admin@devbox:ansible$ 
</code></pre></div></div>

<p>We will be using the playbook: <code class="highlighter-rouge">configure_bgp_netconf.yml</code> which uses the netconf_config module which in turn utilizes the XML encoded data to configure BGP on routers r1 and r2:</p>

<p>The playbook is dumped below:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>admin@devbox:ansible$ 
admin@devbox:ansible$ cat configure_bgp_netconf.yml 
---
- hosts: routers_shell
  connection: local
  gather_facts: no

  tasks:
  - name: Configure BGP on the router
    netconf_config:
      host: ""
      port: ""
      username: ""
      password: ""
      hostkey_verify: no
      xml: ""
admin@devbox:ansible$ 
admin@devbox:ansible$ 
</code></pre></div></div>

<p>The xml file used by the above playbook to configure BGP on router r1 is shown below. 
This XML data utilizes the IOS-XR BGP Config YANG model:  <code class="highlighter-rouge">Cisco-IOS-XR-ipv4-bgp-cfg</code>.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>admin@devbox:ansible$ cat xml/r1-bgp.xml 
&lt;config&gt;
  &lt;bgp xmlns="http://cisco.com/ns/yang/Cisco-IOS-XR-ipv4-bgp-cfg"&gt;
   &lt;instance&gt;
    &lt;instance-name&gt;default&lt;/instance-name&gt;
    &lt;instance-as&gt;
     &lt;as&gt;0&lt;/as&gt;
     &lt;four-byte-as&gt;
      &lt;as&gt;65000&lt;/as&gt;
      &lt;bgp-running&gt;&lt;/bgp-running&gt;
      &lt;default-vrf&gt;
       &lt;global&gt;
        &lt;router-id&gt;50.1.1.1&lt;/router-id&gt;
        &lt;global-afs&gt;
         &lt;global-af&gt;
          &lt;af-name&gt;ipv4-unicast&lt;/af-name&gt;
          &lt;enable&gt;&lt;/enable&gt;
         &lt;/global-af&gt;
        &lt;/global-afs&gt;
       &lt;/global&gt;
       &lt;bgp-entity&gt;
        &lt;neighbors&gt;
         &lt;neighbor&gt;
          &lt;neighbor-address&gt;60.1.1.1&lt;/neighbor-address&gt;
          &lt;remote-as&gt;
           &lt;as-xx&gt;0&lt;/as-xx&gt;
           &lt;as-yy&gt;65000&lt;/as-yy&gt;
          &lt;/remote-as&gt;
          &lt;update-source-interface&gt;Loopback0&lt;/update-source-interface&gt;
          &lt;neighbor-afs&gt;
           &lt;neighbor-af&gt;
            &lt;af-name&gt;ipv4-unicast&lt;/af-name&gt;
            &lt;activate&gt;&lt;/activate&gt;
           &lt;/neighbor-af&gt;
          &lt;/neighbor-afs&gt;
         &lt;/neighbor&gt;
        &lt;/neighbors&gt;
       &lt;/bgp-entity&gt;
      &lt;/default-vrf&gt;
     &lt;/four-byte-as&gt;
    &lt;/instance-as&gt;
   &lt;/instance&gt;
      &lt;/bgp&gt;
    &lt;/config&gt;
admin@devbox:ansible$ 
</code></pre></div></div>

<p>Similarly, the XML file for router r2:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>admin@devbox:ansible$ 
admin@devbox:ansible$ 
admin@devbox:ansible$ cat xml/r2-bgp.xml 
&lt;config&gt;
  &lt;bgp xmlns="http://cisco.com/ns/yang/Cisco-IOS-XR-ipv4-bgp-cfg"&gt; 
   &lt;instance&gt; 
    &lt;instance-name&gt;default&lt;/instance-name&gt; 
    &lt;instance-as&gt; 
     &lt;as&gt;0&lt;/as&gt; 
     &lt;four-byte-as&gt; 
      &lt;as&gt;65000&lt;/as&gt; 
      &lt;bgp-running&gt;&lt;/bgp-running&gt; 
      &lt;default-vrf&gt; 
       &lt;global&gt; 
        &lt;router-id&gt;60.1.1.1&lt;/router-id&gt; 
        &lt;global-afs&gt; 
         &lt;global-af&gt; 
          &lt;af-name&gt;ipv4-unicast&lt;/af-name&gt; 
          &lt;enable&gt;&lt;/enable&gt; 
         &lt;/global-af&gt; 
        &lt;/global-afs&gt; 
       &lt;/global&gt; 
       &lt;bgp-entity&gt; 
        &lt;neighbors&gt; 
         &lt;neighbor&gt; 
          &lt;neighbor-address&gt;50.1.1.1&lt;/neighbor-address&gt; 
          &lt;remote-as&gt; 
           &lt;as-xx&gt;0&lt;/as-xx&gt; 
           &lt;as-yy&gt;65000&lt;/as-yy&gt; 
          &lt;/remote-as&gt; 
          &lt;update-source-interface&gt;Loopback0&lt;/update-source-interface&gt; 
          &lt;neighbor-afs&gt; 
           &lt;neighbor-af&gt; 
            &lt;af-name&gt;ipv4-unicast&lt;/af-name&gt; 
            &lt;activate&gt;&lt;/activate&gt; 
           &lt;/neighbor-af&gt; 
          &lt;/neighbor-afs&gt; 
         &lt;/neighbor&gt; 
        &lt;/neighbors&gt; 
       &lt;/bgp-entity&gt; 
      &lt;/default-vrf&gt; 
     &lt;/four-byte-as&gt; 
    &lt;/instance-as&gt; 
   &lt;/instance&gt; 
  &lt;/bgp&gt;
&lt;/config&gt;
admin@devbox:ansible$ 
</code></pre></div></div>

<h3 id="install-ncclient">Install ncclient</h3>

<p>ncclient is an open source library (<a href="https://pypi.org/project/ncclient/">https://pypi.org/project/ncclient/</a>) that can be used to connect to the netconf subsystem over SSH for multiple different vendor OSes (including IOS-XR).
It then allows the user to pass in XML encoded YANG data to interact with the router OS and manipulate its provisioned state or extract operational data.</p>

<p>The Ansible netconf_config module requires ncclient to be installed on the system. Let’s install ncclient first:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>admin@devbox:ansible$ sudo pip2 install ncclient
The directory '/home/admin/.cache/pip/http' or its parent directory is not owned by the current user and the cache has been disabled. Please check the permissions and owner of that directory. If executing pip with sudo, you may want sudo's -H flag.
The directory '/home/admin/.cache/pip' or its parent directory is not owned by the current user and caching wheels has been disabled. check the permissions and owner of that directory. If executing pip with sudo, you may want sudo's -H flag.
Collecting ncclient
  Downloading https://files.pythonhosted.org/packages/dc/95/acc44c2ff966743fedd1ad991ecf2498f40fd434883c67138b60a6373d49/ncclient-0.6.3.tar.gz (88kB)
    100% |████████████████████████████████| 92kB 598kB/s 
Requirement already satisfied: setuptools&gt;0.6 in /usr/lib/python3/dist-packages (from ncclient) (20.7.0)
Requirement already satisfied: paramiko&gt;=1.15.0 in /usr/local/lib/python3.5/dist-packages (from ncclient) (2.4.2)
Collecting lxml&gt;=3.3.0 (from ncclient)
  Downloading https://files.pythonhosted.org/packages/f0/b6/6423a06e3fd191c5c9bea3cd636a175eb7b0b3e3c8d5c58c4e6bf3b43193/lxml-4.3.0-cp35-cp35m-manylinux1_x86_64.whl (5.6MB)
    100% |████████████████████████████████| 5.6MB 7.5MB/s 
Collecting selectors2&gt;=2.0.1 (from ncclient)
  Downloading https://files.pythonhosted.org/packages/c9/89/8a07d6d6c78422c5151f68453e9741af4cd82bebcfa73923f73b3bdbef0d/selectors2-2.0.1-py2.py3-none-any.whl
Requirement already satisfied: six in /usr/lib/python3/dist-packages (from ncclient) (1.10.0)
Requirement already satisfied: pynacl&gt;=1.0.1 in /usr/local/lib/python3.5/dist-packages (from paramiko&gt;=1.15.0-&gt;ncclient) (1.3.0)
Requirement already satisfied: cryptography&gt;=1.5 in /usr/local/lib/python3.5/dist-packages (from paramiko&gt;=1.15.0-&gt;ncclient) (2.5)
Requirement already satisfied: pyasn1&gt;=0.1.7 in /usr/local/lib/python3.5/dist-packages (from paramiko&gt;=1.15.0-&gt;ncclient) (0.4.5)
Requirement already satisfied: bcrypt&gt;=3.1.3 in /usr/local/lib/python3.5/dist-packages (from paramiko&gt;=1.15.0-&gt;ncclient) (3.1.6)
Requirement already satisfied: cffi&gt;=1.4.1 in /usr/local/lib/python3.5/dist-packages (from pynacl&gt;=1.0.1-&gt;paramiko&gt;=1.15.0-&gt;ncclient) (1.11.5)
Requirement already satisfied: asn1crypto&gt;=0.21.0 in /usr/local/lib/python3.5/dist-packages (from cryptography&gt;=1.5-&gt;paramiko&gt;=1.15.0-&gt;ncclient) (0.24.0)
Requirement already satisfied: pycparser in /usr/local/lib/python3.5/dist-packages (from cffi&gt;=1.4.1-&gt;pynacl&gt;=1.0.1-&gt;paramiko&gt;=1.15.0-&gt;ncclient) (2.19)
Installing collected packages: lxml, selectors2, ncclient
  Running setup.py install for ncclient ... done
Successfully installed lxml-4.3.0 ncclient-0.6.3 selectors2-2.0.1
You are using pip version 10.0.1, however version 19.0.1 is available.
You should consider upgrading via the 'pip install --upgrade pip' command.
admin@devbox:ansible$ 

</code></pre></div></div>

<p>In the end, you should have a relatively latest version of ncclient installed (version could differ based on when you run this lab):</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>admin@devbox:ansible$ pip2 list | grep ncclient
ncclient                0.6.3  
admin@devbox:ansible$
</code></pre></div></div>

<h3 id="execute-the-ansible-playbook-to-configure-bgp">Execute the Ansible playbook to configure BGP</h3>

<p>With ncclient installed, execute the Ansible playbook to configure BGP on the two routers:</p>

<blockquote>
  <p><strong>IMPORTANT:</strong> Before you run the ansible playbook, make sure you set the &gt;ANSIBLE_HOST_KEY_CHECKING 
environment variable to false to allow Ansible to easily connect without being stalled by key
checking requirements for the two routers. This can also be set in the ansible_cfg file instead.</p>
</blockquote>

<blockquote>
  <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>admin@devbox:ansible$ 
admin@devbox:ansible$ export ANSIBLE_HOST_KEY_CHECKING=False
</code></pre></div>  </div>
  <p>{: .notice–danger} .</p>
</blockquote>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>admin@devbox:ansible$ ansible-playbook -i ansible_hosts configure_bgp_netconf.yml 

PLAY [routers_shell] ********************************************************************************************************************

TASK [Configure BGP on the router] ******************************************************************************************************
ok: [r1]
ok: [r2]

PLAY RECAP ******************************************************************************************************************************
r1                         : ok=1    changed=0    unreachable=0    failed=0   
r2                         : ok=1    changed=0    unreachable=0    failed=0   

admin@devbox:ansible$ 

</code></pre></div></div>

<h3 id="check-the-bgp-configuration-on-the-routers">Check the BGP configuration on the routers</h3>

<p>Hop over to router r1 and see that BGP has been configured:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>AKSHSHAR-M-33WP:~ akshshar$ ssh -p 2221 admin@10.10.20.170


--------------------------------------------------------------------------
  Router 1 (Cisco IOS XR Sandbox)
--------------------------------------------------------------------------


Password: 


RP/0/RP0/CPU0:r1#
RP/0/RP0/CPU0:r1#show run router bgp
Wed Jan 30 04:32:27.173 UTC
router bgp 65000
 bgp router-id 50.1.1.1
 address-family ipv4 unicast
 !
 neighbor 60.1.1.1
  remote-as 65000
  update-source Loopback0
  address-family ipv4 unicast
  !
 !
!

RP/0/RP0/CPU0:r1#


</code></pre></div></div>

<p>Similarly, on router r2:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
RP/0/RP0/CPU0:r2#show run router bgp
Wed Jan 30 04:29:24.722 UTC
% No such configuration item(s)

RP/0/RP0/CPU0:r2#show run router bgp
Wed Jan 30 04:32:14.159 UTC
router bgp 65000
 bgp router-id 60.1.1.1
 address-family ipv4 unicast
 !
 neighbor 50.1.1.1
  remote-as 65000
  update-source Loopback0
  address-family ipv4 unicast
  !
 !
!

RP/0/RP0/CPU0:r2#


</code></pre></div></div>

<h2 id="ydk">YDK</h2>

<p>To know more about YDK, head over to <a href="http://ydk.io">http://ydk.io</a></p>

<h3 id="ydk-python-script-to-configure-model-driven-telemetry">YDK python script to configure Model-Driven Telemetry</h3>

<p>YDK-py is already installed in the devbox for you.</p>

<p>Jump into the <code class="highlighter-rouge">ydk</code> directory in the clone github repository:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>admin@devbox:~$ cd ~/xr-programmability-lab-code/
admin@devbox:xr-programmability-lab-code$ cd ydk/
admin@devbox:ydk$ 
</code></pre></div></div>

<blockquote>
  <p>Writing your own python script with YDK to interact with Yang models on IOS-XR and the other Vendor OSes is straightforward and you will find tons of resources in the git repository:
https://github.com/CiscoDevNet/ydk-py-samples with hundreds of examples across different models supported by IOS-XR.</p>
</blockquote>

<p>The YDK script used for this purpose is shown below:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>admin@devbox:ydk$ cat configure_telemetry_openconfig.py 
#!/usr/bin/env python
#
# Copyright 2016 Cisco Systems, Inc.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

"""
Create configuration for model openconfig-telemetry.

usage: configure_telemetry_openconfig.py [-h] [-v] device

positional arguments:
  device         NETCONF device (ssh://user:password@host:port)

optional arguments:
  -h, --help     show this help message and exit
  -v, --verbose  print debugging messages
"""

from argparse import ArgumentParser
from urlparse import urlparse

from ydk.services import CRUDService
from ydk.providers import NetconfServiceProvider
from ydk.models.openconfig import openconfig_telemetry \
    as oc_telemetry
import logging


def config_telemetry_system(telemetry_system):
    """Add config data to telemetry_system object."""
    #sensor-group
    sensor_group = telemetry_system.sensor_groups.SensorGroup()


    sensor_group.sensor_group_id = "BGPSession"

    sensor_path = sensor_group.sensor_paths.SensorPath()
    sensor_path.path = "Cisco-IOS-XR-ipv4-bgp-oper:bgp/instances/instance/instance-active/default-vrf/sessions"
    sensor_group.sensor_paths.sensor_path.append(sensor_path)
    telemetry_system.sensor_groups.sensor_group.append(sensor_group)

    sensor_path = sensor_group.sensor_paths.SensorPath()
    sensor_path.path = "Cisco-IOS-XR-ipv4-bgp-oper:bgp/instances/instance/instance-active/default-vrf/process-info"
    sensor_group.sensor_paths.sensor_path.append(sensor_path)
    telemetry_system.sensor_groups.sensor_group.append(sensor_group)


    sensor_group = telemetry_system.sensor_groups.SensorGroup()
    sensor_group.sensor_group_id = "IPV6Neighbor"

    sensor_path = sensor_group.sensor_paths.SensorPath()
    sensor_path.path = "Cisco-IOS-XR-ipv6-nd-oper:ipv6-node-discovery/nodes/node/neighbor-interfaces/neighbor-interface/host-addresses/host-address"
    sensor_group.sensor_paths.sensor_path.append(sensor_path)
    telemetry_system.sensor_groups.sensor_group.append(sensor_group)


    #subscription
    subscription = telemetry_system.subscriptions.persistent.Subscription()
    subscription.subscription_id = 1
    sensor_profile = subscription.sensor_profiles.SensorProfile()
    sensor_profile.sensor_group = "BGPSession"
    sensor_profile.config.sensor_group = "BGPSession"
    sensor_profile.config.sample_interval = 15000
    subscription.sensor_profiles.sensor_profile.append(sensor_profile)
    telemetry_system.subscriptions.persistent.subscription.append(subscription)

    subscription = telemetry_system.subscriptions.persistent.Subscription()
    subscription.subscription_id = 2
    sensor_profile = subscription.sensor_profiles.SensorProfile()
    sensor_profile.sensor_group = "IPV6Neighbor"
    sensor_profile.config.sensor_group = "IPV6Neighbor"
    sensor_profile.config.sample_interval = 15000
    subscription.sensor_profiles.sensor_profile.append(sensor_profile)
    telemetry_system.subscriptions.persistent.subscription.append(subscription)

if __name__ == "__main__":
    """Execute main program."""
    parser = ArgumentParser()
    parser.add_argument("-v", "--verbose", help="print debugging messages",
                        action="store_true")
    parser.add_argument("device",
                        help="NETCONF device (ssh://user:password@host:port)")
    args = parser.parse_args()
    device = urlparse(args.device)

    # log debug messages if verbose argument specified
    if args.verbose:
        logger = logging.getLogger("ydk")
        logger.setLevel(logging.INFO)
        handler = logging.StreamHandler()
        formatter = logging.Formatter(("%(asctime)s - %(name)s - "
                                      "%(levelname)s - %(message)s"))
        handler.setFormatter(formatter)
        logger.addHandler(handler)

    # create NETCONF provider
    provider = NetconfServiceProvider(address=device.hostname,
                                      port=device.port,
                                      username=device.username,
                                      password=device.password,
                                      protocol=device.scheme)
    # create CRUD service
    crud = CRUDService()

    telemetry_system = oc_telemetry.TelemetrySystem()  # create object
    config_telemetry_system(telemetry_system)  # add object configuration

    # create configuration on NETCONF device
    crud.create(provider, telemetry_system)

    exit()
# End of script
admin@devbox:ydk$ 


</code></pre></div></div>

<h3 id="execute-the-ydk-script">Execute the YDK script:</h3>

<p>We intend to configure Model Driven Telemetry on router r1 so that it is ready to stream data associated with BGP Sessions, BGP process and IPv6 neighbor data in the above example.
The Telemetry client we write later will try and receive the BGP session information from the router.</p>

<p>Execute the YDK script, passing to it the credentials and connection details for Router r1 and its netconf port:</p>

<p>Pass the <code class="highlighter-rouge">-v</code> option to the script to dump the requests/responses as the script executes.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>admin@devbox:ydk$ 
admin@devbox:ydk$ ./configure_telemetry_openconfig.py -v ssh://vagrant:vagrant@10.10.20.170:8321
2019-01-29 21:02:48,375 - ydk - INFO - Path where models are to be downloaded: /home/admin/.ydk/10.10.20.170_8321
2019-01-29 21:02:48,386 - ydk - INFO - Connected to 10.10.20.170 on port 8321 using ssh with timeout of -1
2019-01-29 21:02:48,396 - ydk - INFO - Executing CRUD create operation on [openconfig-telemetry:telemetry-system]
2019-01-29 21:02:52,735 - ydk - INFO - =============Generating payload to send to device=============
2019-01-29 21:02:52,735 - ydk - INFO - 
&lt;rpc xmlns="urn:ietf:params:xml:ns:netconf:base:1.0"&gt;
&lt;edit-config xmlns="urn:ietf:params:xml:ns:netconf:base:1.0"&gt;
  &lt;target&gt;
    &lt;candidate/&gt;
  &lt;/target&gt;
  &lt;error-option&gt;rollback-on-error&lt;/error-option&gt;
  &lt;config&gt;&lt;telemetry-system xmlns="http://openconfig.net/yang/telemetry" xmlns:nc="urn:ietf:params:xml:ns:netconf:base:1.0" nc:operation="merge"&gt;
  &lt;sensor-groups&gt;
    &lt;sensor-group&gt;
      &lt;sensor-group-id&gt;BGPSession&lt;/sensor-group-id&gt;
      &lt;sensor-paths&gt;
        &lt;sensor-path&gt;
          &lt;path&gt;Cisco-IOS-XR-ipv4-bgp-oper:bgp/instances/instance/instance-active/default-vrf/sessions&lt;/path&gt;
        &lt;/sensor-path&gt;
        &lt;sensor-path&gt;
          &lt;path&gt;Cisco-IOS-XR-ipv4-bgp-oper:bgp/instances/instance/instance-active/default-vrf/process-info&lt;/path&gt;
        &lt;/sensor-path&gt;
      &lt;/sensor-paths&gt;
    &lt;/sensor-group&gt;
    &lt;sensor-group&gt;
      &lt;sensor-group-id&gt;IPV6Neighbor&lt;/sensor-group-id&gt;
      &lt;sensor-paths&gt;
        &lt;sensor-path&gt;
          &lt;path&gt;Cisco-IOS-XR-ipv6-nd-oper:ipv6-node-discovery/nodes/node/neighbor-interfaces/neighbor-interface/host-addresses/host-address&lt;/path&gt;
        &lt;/sensor-path&gt;
      &lt;/sensor-paths&gt;
    &lt;/sensor-group&gt;
  &lt;/sensor-groups&gt;
  &lt;subscriptions&gt;
    &lt;persistent&gt;
      &lt;subscription&gt;
        &lt;subscription-id&gt;1&lt;/subscription-id&gt;
        &lt;sensor-profiles&gt;
          &lt;sensor-profile&gt;
            &lt;sensor-group&gt;BGPSession&lt;/sensor-group&gt;
            &lt;config&gt;
              &lt;sensor-group&gt;BGPSession&lt;/sensor-group&gt;
              &lt;sample-interval&gt;15000&lt;/sample-interval&gt;
            &lt;/config&gt;
          &lt;/sensor-profile&gt;
        &lt;/sensor-profiles&gt;
      &lt;/subscription&gt;
      &lt;subscription&gt;
        &lt;subscription-id&gt;2&lt;/subscription-id&gt;
        &lt;sensor-profiles&gt;
          &lt;sensor-profile&gt;
            &lt;sensor-group&gt;IPV6Neighbor&lt;/sensor-group&gt;
            &lt;config&gt;
              &lt;sensor-group&gt;IPV6Neighbor&lt;/sensor-group&gt;
              &lt;sample-interval&gt;15000&lt;/sample-interval&gt;
            &lt;/config&gt;
          &lt;/sensor-profile&gt;
        &lt;/sensor-profiles&gt;
      &lt;/subscription&gt;
    &lt;/persistent&gt;
  &lt;/subscriptions&gt;
&lt;/telemetry-system&gt;
&lt;/config&gt;
&lt;/edit-config&gt;
&lt;/rpc&gt;
2019-01-29 21:02:52,738 - ydk - INFO - 

2019-01-29 21:02:52,789 - ydk - INFO - =============Reply payload received from device=============
2019-01-29 21:02:52,789 - ydk - INFO - 
&lt;?xml version="1.0"?&gt;
&lt;rpc-reply xmlns="urn:ietf:params:xml:ns:netconf:base:1.0" message-id="1"&gt;
  &lt;ok/&gt;
&lt;/rpc-reply&gt;

2019-01-29 21:02:52,791 - ydk - INFO - 

2019-01-29 21:02:52,791 - ydk - INFO - =============Executing commit=============
2019-01-29 21:02:52,791 - ydk - INFO - 
&lt;rpc xmlns="urn:ietf:params:xml:ns:netconf:base:1.0"&gt;
  &lt;commit/&gt;
&lt;/rpc&gt;

2019-01-29 21:02:53,092 - ydk - INFO - =============Reply payload received from device=============
2019-01-29 21:02:53,092 - ydk - INFO - 
&lt;?xml version="1.0"?&gt;
&lt;rpc-reply xmlns="urn:ietf:params:xml:ns:netconf:base:1.0" message-id="2"&gt;
  &lt;ok/&gt;
&lt;/rpc-reply&gt;

2019-01-29 21:02:53,093 - ydk - INFO - 

2019-01-29 21:02:53,094 - ydk - INFO - Operation succeeded
2019-01-29 21:02:53,094 - ydk - INFO - Disconnected from device
admin@devbox:ydk$ 

</code></pre></div></div>

<h3 id="check-the-telemetry-configuration-on-router-r1">Check the Telemetry configuration on router r1</h3>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>AKSHSHAR-M-33WP:~ akshshar$ ssh -p 2221 admin@10.10.20.170


--------------------------------------------------------------------------
  Router 1 (Cisco IOS XR Sandbox)
--------------------------------------------------------------------------


Password: 


RP/0/RP0/CPU0:r1#
RP/0/RP0/CPU0:r1#
RP/0/RP0/CPU0:r1#show  running-config telemetry model-driven 
Wed Jan 30 05:05:03.128 UTC
telemetry model-driven
 sensor-group BGPSession
  sensor-path Cisco-IOS-XR-ipv4-bgp-oper:bgp/instances/instance/instance-active/default-vrf/sessions
  sensor-path Cisco-IOS-XR-ipv4-bgp-oper:bgp/instances/instance/instance-active/default-vrf/process-info
 !
 sensor-group IPV6Neighbor
  sensor-path Cisco-IOS-XR-ipv6-nd-oper:ipv6-node-discovery/nodes/node/neighbor-interfaces/neighbor-interface/host-addresses/host-address
 !
 subscription 1
  sensor-group-id BGPSession sample-interval 15000
 !
 subscription 2
  sensor-group-id IPV6Neighbor sample-interval 15000
 !
!

RP/0/RP0/CPU0:r1#
</code></pre></div></div>

<h3 id="verify-that-the-telemetry-sensor-paths-are-resolved">Verify that the Telemetry sensor-paths are resolved</h3>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>RP/0/RP0/CPU0:r1#show telemetry model-driven subscription 1
Wed Jan 30 05:07:56.424 UTC
Subscription:  1
-------------
  State:       NA
  Sensor groups:
  Id: BGPSession
    Sample Interval:      15000 ms
    Sensor Path:          Cisco-IOS-XR-ipv4-bgp-oper:bgp/instances/instance/instance-active/default-vrf/sessions
    Sensor Path State:    Resolved
    Sensor Path:          Cisco-IOS-XR-ipv4-bgp-oper:bgp/instances/instance/instance-active/default-vrf/process-info
    Sensor Path State:    Resolved

  Collection Groups:
  ------------------
  No active collection groups

RP/0/RP0/CPU0:r1#show telemetry model-driven subscription 2
Wed Jan 30 05:07:59.312 UTC
Subscription:  2
-------------
  State:       NA
  Sensor groups:
  Id: IPV6Neighbor
    Sample Interval:      15000 ms
    Sensor Path:          Cisco-IOS-XR-ipv6-nd-oper:ipv6-node-discovery/nodes/node/neighbor-interfaces/neighbor-interface/host-addresses/host-address
    Sensor Path State:    Resolved

  Collection Groups:
  ------------------
  No active collection groups

RP/0/RP0/CPU0:r1#

</code></pre></div></div>

<p class="notice--success">Awesome! You’re now ready to stream telemetry data from the above sensor-paths. Let’s proceed to run a custom python Telemetry client.</p>

<h2 id="writing-your-own-python-telemetry-client">Writing your own Python Telemetry client</h2>

<p>The Telemetry client is written based on the same concept described in the following learning lab:
<a href="https://learninglabs.cisco.com/tracks/iosxr-programmability/iosxr-streaming-telemetry/03-iosxr-02-telemetry-python/step/1">https://learninglabs.cisco.com/tracks/iosxr-programmability/iosxr-streaming-telemetry/03-iosxr-02-telemetry-python/step/1</a></p>

<p>We make it slightly simpler and instead of requesting telemetry data in a GPB format, we simply request json and dump it.</p>

<p>Before we start, install the dependencies required to connect to the router over gRPC to receive the data.</p>

<h3 id="install-dependencies-for-the-grpc-telemetry-client">Install dependencies for the gRPC telemetry client</h3>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>admin@devbox:~$ sudo pip2 install grpcio-tools==1.7.0 googleapis-common-protos
The directory '/home/admin/.cache/pip/http' or its parent directory is not owned by the current user and the cache has been disabled. Please check the permissions and owner of that directory. If executing pip with sudo, you may want sudo's -H flag.
The directory '/home/admin/.cache/pip' or its parent directory is not owned by the current user and caching wheels has been disabled. check the permissions and owner of that directory. If executing pip with sudo, you may want sudo's -H flag.
Collecting grpcio-tools==1.7.0
  Downloading https://files.pythonhosted.org/packages/0e/c3/d9a9960f12e0bab789da875b1c9a3eb348b51fa3af9544c1edd1f7ef6000/grpcio_tools-1.7.0-cp27-cp27mu-manylinux1_x86_64.whl (21.3MB)
    100% |████████████████████████████████| 21.3MB 50kB/s 
Collecting googleapis-common-protos
  Downloading https://files.pythonhosted.org/packages/61/29/1549f61917eadd11650e42b78b4afcfe9cb467157af4510ab8cb59535f14/googleapis-common-protos-1.5.6.tar.gz
Requirement already satisfied (use --upgrade to upgrade): protobuf&gt;=3.3.0 in /usr/local/lib/python2.7/dist-packages (from grpcio-tools==1.7.0)
Requirement already satisfied (use --upgrade to upgrade): grpcio&gt;=1.7.0 in /usr/local/lib/python2.7/dist-packages (from grpcio-tools==1.7.0)
Requirement already satisfied (use --upgrade to upgrade): setuptools in /usr/lib/python2.7/dist-packages (from protobuf&gt;=3.3.0-&gt;grpcio-tools==1.7.0)
Requirement already satisfied (use --upgrade to upgrade): six&gt;=1.9 in /usr/lib/python2.7/dist-packages (from protobuf&gt;=3.3.0-&gt;grpcio-tools==1.7.0)
Requirement already satisfied (use --upgrade to upgrade): enum34&gt;=1.0.4 in /usr/lib/python2.7/dist-packages (from grpcio&gt;=1.7.0-&gt;grpcio-tools==1.7.0)
Requirement already satisfied (use --upgrade to upgrade): futures&gt;=2.2.0 in /usr/local/lib/python2.7/dist-packages (from grpcio&gt;=1.7.0-&gt;grpcio-tools==1.7.0)
Installing collected packages: grpcio-tools, googleapis-common-protos
  Running setup.py install for googleapis-common-protos ... done
Successfully installed googleapis-common-protos-1.5.6 grpcio-tools-1.7.0
You are using pip version 8.1.1, however version 19.0.1 is available.
You should consider upgrading via the 'pip install --upgrade pip' command.
admin@devbox:~$ 
</code></pre></div></div>

<h3 id="clone-the-telemetry-grpc-collectors-git-repo">Clone the Telemetry gRPC collectors git repo</h3>

<p>We have published a few samples for c++ and python to help developers write their own gRPC based collectors to receive telemetry data from IOS-XR.</p>

<p>The proto files that we use to create bindings and then write our own clients are published here: <a href="https://github.com/cisco/bigmuddy-network-telemetry-proto/">https://github.com/cisco/bigmuddy-network-telemetry-proto/</a></p>

<p>To start, first clone the telemetry-grpc-collectors repo into the devbox home directory:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>admin@devbox:~$ 
admin@devbox:~$ git clone --recursive https://github.com/ios-xr/telemetry-grpc-collectors
Cloning into 'telemetry-grpc-collectors'...
remote: Enumerating objects: 16, done.
remote: Counting objects: 100% (16/16), done.
remote: Compressing objects: 100% (11/11), done.
remote: Total 137 (delta 4), reused 15 (delta 4), pack-reused 121
Receiving objects: 100% (137/137), 3.67 MiB | 2.79 MiB/s, done.
Resolving deltas: 100% (62/62), done.
Checking connectivity... done.
Submodule 'bigmuddy-network-telemetry-proto' (https://github.com/cisco/bigmuddy-network-telemetry-proto) registered for path 'bigmuddy-network-telemetry-proto'
Cloning into 'bigmuddy-network-telemetry-proto'...
remote: Enumerating objects: 24542, done.
remote: Total 24542 (delta 0), reused 0 (delta 0), pack-reused 24542
Receiving objects: 100% (24542/24542), 6.06 MiB | 3.14 MiB/s, done.
Resolving deltas: 100% (8337/8337), done.
Checking connectivity... done.
Submodule path 'bigmuddy-network-telemetry-proto': checked out '4419cd20fb73f05d059a37fa3e41fe55f02a528f'
admin@devbox:~$ 


</code></pre></div></div>

<h3 id="build-the-bindings-for-model-driven-telemetry-grpc-clients">Build the Bindings for Model Driven Telemetry gRPC clients</h3>

<p>Hop into the <code class="highlighter-rouge">build/python/</code> directory and generate the required bindings from the proto files:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>admin@devbox:~$ 
admin@devbox:~$ cd telemetry-grpc-collectors/build/python/
admin@devbox:python$ 
admin@devbox:python$ 
admin@devbox:python$ ./gen-mdt-dialin-bindings.sh 
Generating Python bindings...Done
admin@devbox:python$ 
admin@devbox:python$ tree src/genpy/
src/genpy/
├── __init__.py
├── mdt_grpc_dialin
│   ├── __init__.py
│   ├── mdt_grpc_dialin_pb2_grpc.py
│   └── mdt_grpc_dialin_pb2.py
├── mdt_grpc_dialout
│   ├── __init__.py
│   ├── mdt_grpc_dialout_pb2_grpc.py
│   └── mdt_grpc_dialout_pb2.py
├── telemetry_pb2_grpc.py
└── telemetry_pb2.py

2 directories, 9 files
admin@devbox:python$ 

</code></pre></div></div>

<h3 id="running-a-simple-python-telemetry-client">Running a simple python Telemetry client</h3>

<p>Hop into the <code class="highlighter-rouge">clients/python/</code> directory and dump the <code class="highlighter-rouge">telemetry_client_json.py</code> script which is written to connect to an IOS-XR router over gRPC, request a json data-stream and dump it to the screen.</p>

<p>The script is dumped below.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>admin@devbox:~$ 
admin@devbox:~$ cd ~/telemetry-grpc-collectors/clients/python/
admin@devbox:python$ ls
telemetry_client_json.py  telemetry_client.py
admin@devbox:python$ cat telemetry_client_json.py 
#!/usr/bin/env python

# Standard python libs
import os,sys
sys.path.append("../../build/python/src/genpy")

import ast, pprint 
import pdb
import yaml, json
import telemetry_pb2
from mdt_grpc_dialin import mdt_grpc_dialin_pb2
from mdt_grpc_dialin import mdt_grpc_dialin_pb2_grpc
import grpc
 
#
# Get the GRPC Server IP address and port number
#
def get_server_ip_port():
    # Get GRPC Server's IP from the environment
    if 'SERVER_IP' not in os.environ.keys():
        print("Need to set the SERVER_IP env variable e.g.")
        print("export SERVER_IP='10.30.110.214'")
        os._exit(0)
    
    # Get GRPC Server's Port from the environment
    if 'SERVER_PORT' not in os.environ.keys():
        print("Need to set the SERVER_PORT env variable e.g.")
        print("export SERVER_PORT='57777'")
        os._exit(0)
    
    return (os.environ['SERVER_IP'], int(os.environ['SERVER_PORT']))


#
# Setup the GRPC channel with the server, and issue RPCs
#
if __name__ == '__main__':
    server_ip, server_port = get_server_ip_port()

    print("Using GRPC Server IP(%s) Port(%s)" %(server_ip, server_port))

    # Create the channel for gRPC.
    channel = grpc.insecure_channel(str(server_ip)+":"+str(server_port))

    unmarshal = True

    # Ereate the gRPC stub.
    stub = mdt_grpc_dialin_pb2_grpc.gRPCConfigOperStub(channel)

    metadata = [('username', 'vagrant'), ('password', 'vagrant')]
    Timeout = 3600*24*365 # Seconds

    sub_args = mdt_grpc_dialin_pb2.CreateSubsArgs(ReqId=99, encode=4, subidstr='1')
    stream = stub.CreateSubs(sub_args, timeout=Timeout, metadata=metadata)
    for segment in stream:
        if not unmarshal:
            print(segment)
        else:
            # Go straight for telemetry data
            telemetry_pb = telemetry_pb2.Telemetry()

            encoding_path = 'Cisco-IOS-XR-ipv4-bgp-oper:bgp/instances/'+\
                            'instance/instance-active/default-vrf/sessions/session'


            try:
                # Return in JSON format instead of protobuf.
                if json.loads(segment.data)["encoding_path"] == encoding_path: 
                    print(json.dumps(json.loads(segment.data), indent=3))
            except Exception as e: 
                print("Failed to receive data, error: " +str(e))
    os._exit(0)
admin@devbox:python$ 
</code></pre></div></div>

<p>Finally, open up a new shell and run this script to start receiving data from IOS-XR.
Make sure you export the connection details for the gRPC server running on router r1 before running the script.</p>

<div class="notice--info highlighter-rouge"><div class="highlight"><pre class="highlight"><code>export SERVER_IP=10.10.20.170
export SERVER_PORT=57021

</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>admin@devbox:python$ 
admin@devbox:python$ export SERVER_IP=10.10.20.170
admin@devbox:python$ export SERVER_PORT=57021
admin@devbox:python$ 
admin@devbox:python$ ./telemetry_client_json.py 
Using GRPC Server IP(10.10.20.170) Port(57021)
{
   "encoding_path": "Cisco-IOS-XR-ipv4-bgp-oper:bgp/instances/instance/instance-active/default-vrf/sessions/session", 
   "subscription_id_str": "1", 
   "collection_start_time": 1548827148102, 
   "msg_timestamp": 1548827148108, 
   "collection_end_time": 1548827148108, 
   "node_id_str": "r1", 
   "data_json": [
      {
         "keys": {
            "neighbor-address": "60.1.1.1", 
            "instance-name": "default"
         }, 
         "timestamp": 1548827148107, 
         "content": {
            "messages-queued-in": 0, 
            "is-local-address-configured": false, 
            "local-as": 65000, 
            "nsr-state": "bgp-nbr-nsr-st-none", 
            "description": "", 
            "connection-remote-address": {
               "ipv4-address": "60.1.1.1", 
               "afi": "ipv4"
            }, 
            "messages-queued-out": 0, 
            "connection-state": "bgp-st-idle", 
            "speaker-id": 0, 
            "vrf-name": "default", 
            "remote-as": 65000, 
            "postit-pending": false, 
            "nsr-enabled": true, 
            "connection-local-address": {
               "ipv4-address": "0.0.0.0", 
               "afi": "ipv4"
            }
         }
      }
   ], 
   "collection_id": 16
}



</code></pre></div></div>

<p class="notice--success">Perfect! Now, we’re all set up to deploy Open/R as an application on the two routers and test out Application-hosting, packet-io and Service-Layer APIs in XR together.</p>
